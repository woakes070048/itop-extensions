<?xml version="1.0" encoding="UTF-8"?>
<itop_design xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" version="1.2">
	<constants>
	</constants>
	<classes>
		<class id="VLAN" _delta="delete"></class>
		<class id="lnkSubnetToVLAN" _delta="delete"></class>
		<class id="Subnet" _delta="delete"></class>
		<class id="lnkPhysicalInterfaceToVLAN" _delta="delete"></class>
		<class id="Patch" _delta="delete"></class>
		<class id="lnkDocumentToPatch" _delta="delete"></class>
		<class id="lnkSoftwareInstanceToSoftwarePatch" _delta="delete"></class>
		<class id="lnkFunctionalCIToOSPatch" _delta="delete"></class>
		<class id="Middleware" _delta="delete"></class>
		<class id="PCSoftware" _delta="delete"></class>
		<class id="OtherSoftware" _delta="delete"></class>
		<class id="MiddlewareInstance" _delta="delete"></class>
		<class id="DatabaseSchema" _delta="delete"></class>
		<class id="Licence" _delta="delete"></class>
		<class id="lnkDocumentToLicence" _delta="delete"></class>
		<class id="Software" _delta="delete"></class>
		<class id="WebServer" _delta="delete"></class>
		<class id="SoftwareInstance" _delta="delete"></class>
		<class id="lnkDocumentToSoftware" _delta="delete"></class>
		<class id="WebApplication" _delta="delete"></class>
		<class id="IOSVersion" _delta="delete"></class>
		<class id="PhysicalInterface" _delta="delete"></class>
		<class id="IPInterface" _delta="delete"></class>
		<class id="NetworkInterface" _delta="delete"></class>
		<class id="NetworkDevice" _delta="delete"></class>
		<class id="lnkConnectableCIToNetworkDevice" _delta="delete"></class>
		<class id="lnkApplicationSolutionToBusinessProcess" _delta="delete"></class>
		<class id="Contact">
			<fields>
				<field id="applicationsolution_list" xsi:type="AttributeLinkedSetIndirect" _delta="define">
					<linked_class>lnkContactToApplicationSolution</linked_class>
					<ext_key_to_me>contact_id</ext_key_to_me>
					<count_min>0</count_min>
					<count_max>0</count_max>
					<ext_key_to_remote>applicationsolution_id</ext_key_to_remote>
					<duplicates/>
				</field>
			</fields>
			<methods>
				<method id="DoCheckToWrite" _delta="define">
					<static>false</static>
					<access>protected</access>
					<type>Overload-DBObject</type>
					<code><![CDATA[	   public function DoCheckToWrite()
		{
		
			parent::DoCheckToWrite();
			// email has to be unique! Currently it' not possible to define this in datamodel (xml)
			$finalclass = $this->Get('finalclass');
			
			$myContactId = UserRights::GetContactId();
			if($this->GetKey() != $myContactId && !UserRights::IsAdministrator())
			{
				$this->m_aCheckIssues[] = Dict::Format("Class:Person/Error:CanOnlyUpdateYourself", $myContactId);
			}

			
			$aChanges = $this->ListChanges();
			if (array_key_exists('email', $aChanges))
			{
				$sContact = $aChanges['email'];
				if($sContact == "")
				{
					return true;
				}
				$oSearch = DBObjectSearch::FromOQL_AllData("SELECT Contact WHERE email=:email");
				$oSet = new DBObjectSet($oSearch, array(), array('email' => $sContact));
				if ($oSet->Count() > 0)
				{
					$this->m_aCheckIssues[] = Dict::Format("Class:Contact/Error:ContactEmailMustBeUnique", $sContact);
				}
			}
			
			if($finalclass == "Team" && array_key_exists('name', $aChanges))
			{
				$sName = $aChanges['name'];
				$oSearch = DBObjectSearch::FromOQL_AllData("SELECT $finalclass WHERE name=:name");
				$oSet = new DBObjectSet($oSearch, array(), array('name' => $sName));
				if ($oSet->Count() > 0)
				{
					$this->m_aCheckIssues[] = Dict::Format("Class:$finalclass/Error:$finalclass" . "NameMustBeUnique", $sName);
				}

			}

		}]]>
					</code>
				</method>
			</methods>
		</class>
		<class id="Person">
			<properties>
				<reconciliation>
					<attributes _delta="redefine">
						<attribute id="name"/>
						<attribute id="first_name"/>
						<attribute id="org_id"/>
						<attribute id="org_name"/>
						<attribute id="email"/>
						<attribute id="phone"/>
					</attributes>
				</reconciliation>
			</properties>
			<fields>
				<field id="location_id" _delta="delete"></field>
				<field id="location_name" _delta="delete"></field>
				<field id="employee_number" _delta="delete"></field>
				<field id="mobile_phone" _delta="delete"></field>
			</fields>
			<presentation>
				<details>
					<items>
						<item id="applicationsolution_list" _delta="define">
							<rank>15</rank>
						</item>
						<item id="col:col1">
							<items>
								<item id="fieldset:Person:info">
									<items>
										<item id="location_id" _delta="delete"></item>
										<item id="employee_number" _delta="delete"></item>		
									</items>
								</item>
							</items>
						</item>
						<item id="col:col2">
							<rank>50</rank>
							<items>
								<item id="fieldset:Person:notifiy">
									<rank>10</rank>
									<items>
										<item id="mobile_phone" _delta="delete"></item>
									</items>
								</item>
							</items>
						</item>

					</items>
				</details>
				<search>
					<items>
						<item id="location_id" _delta="delete"></item>
						<item id="employee_number" _delta="delete"></item>
						<item id="phone" _delta="delete"></item>
						<item id="email" _delta="redefine">
							<rank>10</rank>
						</item>
						<item id="first_name" _delta="redefine">
							<rank>20</rank>
						</item>
						<item id="name" _delta="redefine">
							<rank>30</rank>
						</item>
						<item id="org_id" _delta="redefine">
							<rank>40</rank>
						</item>
						<item id="status" _delta="redefine">
							<rank>60</rank>
						</item>
						<item id="manager_id">
							<rank>90</rank>
						</item>
						<item id="mobile_phone" _delta="delete"></item>
						<item id="notify" _delta="redefine">
							<rank>110</rank>
						</item>
					</items>
				</search>
				<list>
					<items>
						<item id="location_id" _delta="delete"></item>
						<item id="email" _delta="redefine">
							<rank>10</rank>
						</item>
						<item id="phone" _delta="redefine">
							<rank>20</rank>
						</item>
						<item id="status" _delta="redefine">
							<rank>30</rank>
						</item>						
						<item id="org_id" _delta="redefine">
							<rank>40</rank>
						</item>
						<item id="first_name" _delta="delete"></item>
					</items>
				</list>
			</presentation>

		</class>
		<class id="Team">
			<presentation>
				<details>
					<items>
						<item id="applicationsolution_list" _delta="define">
							<rank>85</rank>
						</item>				
					</items>
				</details>
			</presentation>
			<relations>
				<relation id="impacts" _delta="define">
					<neighbours>
						<neighbour id="person">
							<attribute>persons_list</attribute>
						</neighbour>
					</neighbours>
				</relation>
			</relations>
		</class>
		<class id="Location">
			<properties>
				<reconciliation>
					<attributes _delta="redefine">
						<attribute id="name"/>
						<attribute id="isp_id"/>
						<attribute id="isp_name"/>
					</attributes>
				</reconciliation>
				<icon _delta="redefine">../le-config-mgmt/images/idc.png</icon>
			</properties>
			<fields>
				<field id="isp_id" xsi:type="AttributeExternalKey" _delta="define">
					<sql>isp_id</sql>
					<target_class>ISP</target_class>
					<is_null_allowed>true</is_null_allowed>
					<on_target_delete>DEL_AUTO</on_target_delete>
				</field>
				<field id="isp_name" xsi:type="AttributeExternalField" _delta="define">
					<extkey_attcode>isp_id</extkey_attcode>
					<target_attcode>name</target_attcode>
				</field>
				<field id="org_id" _delta="delete"></field>
				<field id="org_name" _delta="delete"></field>
				<field id="postal_code" _delta="delete"></field>
				<field id="person_list" _delta="delete"></field>
				<field id="physicaldevice_list" _delta="delete"></field>
				<field id="server_list" xsi:type="AttributeLinkedSet" _delta="define">
					<linked_class>Server</linked_class>
					<ext_key_to_me>location_id</ext_key_to_me>
					<edit_mode>add_only</edit_mode>
					<count_min>0</count_min>
					<count_max>0</count_max>
				</field>
				<field id="rack_list" xsi:type="AttributeLinkedSet" _delta="define">
					<linked_class>Rack</linked_class>
					<ext_key_to_me>location_id</ext_key_to_me>
					<edit_mode>add_only</edit_mode>
					<count_min>0</count_min>
					<count_max>0</count_max>
				</field>
				
			</fields>
			<presentation>
				<details>
					<items>
						<item id="isp_id">
							<rank>30</rank>
						</item>
						<item id="org_id" _delta="delete"></item>
						<item id="postal_code" _delta="delete"></item>
						<item id="person_list" _delta="delete"></item>
						<item id="physicaldevice_list" _delta="delete"></item>
						<item id="server_list">
							<rank>90</rank>
						</item>
						<item id="rack_list">
							<rank>100</rank>
						</item>
						
					</items>
				</details>
				<search>
					<items>
						<item id="isp_id">
							<rank>30</rank>
						</item>
						<item id="org_id" _delta="delete"></item>
						<item id="postal_code" _delta="delete"></item>
					</items>
				</search>
				<list _delta="redefine">
					<items>
						<item id="isp_id">
							<rank>10</rank>
						</item>
						<item id="city">
							<rank>30</rank>
						</item>
						<item id="country">
							<rank>40</rank>
						</item>
						<item id="status">
							<rank>50</rank>
						</item>

					</items>

				</list>
			</presentation>
			<relations _delta="define">
				<relation id="impacts">
					<neighbours>
						<neighbour id="server">
							<attribute>server_list</attribute>
						</neighbour>
						<neighbour id="rack">
							<attribute>rack_list</attribute>
						</neighbour>						
					</neighbours>
				</relation>
			</relations>
		</class>
		<class id="FunctionalCI">
			<fields>
				<field id="name" xsi:type="AttributeString" _delta="redefine">
					<sql>name</sql>
					<default_value>CI名称不能重复</default_value>
					<is_null_allowed>false</is_null_allowed>
				</field>
				<field id="ci_id" xsi:type="AttributeInteger" _delta="define">
					<sql>ci_id</sql>
					<default_value>1</default_value>
					<is_null_allowed>true</is_null_allowed>
				</field>
				<!--根据lnkContactToFunctionalCI更新此字段-->
				<field id="contacts" xsi:type="AttributeString" _delta="define">
					<sql>contacts</sql>
					<is_null_allowed>true</is_null_allowed>
					<default_value/>
				</field>
			</fields>
			<methods>
				<method id="DoCheckToWrite" _delta="define">
					<static>false</static>
					<access>protected</access>
					<type>Overload-DBObject</type>
					<code><![CDATA[	   public function DoCheckToWrite()
				{
					parent::DoCheckToWrite();
					$ci_id = $this->GetKey();
					if(!$ci_id)
					{
						$this->Set('ci_id',time());
					}else
					{
						$this->Set('ci_id',$ci_id);
					}
					
					$finalclass = $this->Get('finalclass');
					/* all_ip基于PhysicalIP类的变化，这里无需处理
					if($finalclass == "Server")
					{
						$ip_list = $this->GetAsCSV("ip_list");
						$ip_arr = explode("|", $ip_list);
						foreach($ip_arr as $key => $value){
							$oArr = explode(";", $value);
							$ip_arr[$key] = $oArr[1] . "-" . $oArr[0];
							$ip_arr[$key] = preg_replace("/[':\"]|ipaddress|type/", "", $ip_arr[$key]);
						}	
						$all_ip = implode(";", $ip_arr);
						//print_r($all_ip);
						$this->Set("all_ip", $all_ip);
					}*/
					
					// friendlyname of FunctionalCI has to be unique! Currently it' not possible to define this in datamodel (xml)
					$nameSpec = MetaModel::GetNameSpec(get_class($this));
					$sFormat = preg_replace('/%[1-9]\$s/', '%s', $nameSpec['0']);
					$sArg = $nameSpec['1'];
					$oArg = array();
					
					/*
					 * 如果组成friendlyname的所有attribute都没有发生变化，那么不进行检查
					 * 如果不监听变化就进行检查，将导致对象无法更新
					 * server不适用name作为friendlyname，如果finalclass是Server，同时检查name和friendlyname
					 */
					
					// 需要用name作为唯一性校验的Class
					$UniqNameClass = array("Server", "ApplicationSolution");
					
					$aChanges = $this->ListChanges();
					if(in_array($finalclass,$UniqNameClass) && array_key_exists('name', $aChanges))
					{
						$sServer = $aChanges['name'];
						$oSearch = DBObjectSearch::FromOQL_AllData("SELECT Server WHERE name=:name");
						$oSet = new DBObjectSet($oSearch, array(), array('name' => $sServer));
						if ($oSet->Count() > 0)
						{
							$this->m_aCheckIssues[] = Dict::Format("Class:".$finalclass."/Error:".$finalclass."MustBeUnique", $sServer);
						}			
					}
					
					$isChanges = false;
					foreach($aChanges as $key=>$value)
					{   
						if(MetaModel::IsValidKeyAttCode($finalclass, $key))
						{   
							$extKeyFriends = MetaModel::GetExtKeyFriends($finalclass, $key);
							foreach($extKeyFriends as $k=>$v)
							{   
								if(in_array($k, $sArg))
								{   
									$isChanges = true;
								}
							}
						 
						}
						if(in_array($key, $sArg))
						{   
							$isChanges = true;
						}
					}

					
					foreach($sArg as $value) {
						array_push($oArg, $this->Get($value));
					}
					$sFunctionalCI = vsprintf("$sFormat", $oArg);
					
					//print_r($this->Get('name') . "<br>");
					//print_r($this->Get('friendlyname') . "<br>");
					//print_r($oArg);
					//print_r("<br>");
					
					if($isChanges) {
						$oSearch = DBObjectSearch::FromOQL_AllData("SELECT $finalclass WHERE friendlyname=:friendlyname");
						$oSet = new DBObjectSet($oSearch, array(), array('friendlyname' => $sFunctionalCI));
						if ($oSet->Count() > 0)
						{
							$this->m_aCheckIssues[] = Dict::Format("Class:".$finalclass."/Error:".$finalclass."MustBeUnique", $sFunctionalCI);
						}					
					}
				}]]></code>
				</method>

			</methods>

			<relations>
				<relation id="impacts">
					<neighbours>
						<neighbour id="softwareinstance" _delta="delete"></neighbour>
					</neighbours>
				</relation>
			</relations>
		</class>
		<class id="BusinessProcess">
			<properties>
				<icon _delta="redefine">../le-config-mgmt/images/business1.png</icon>
			</properties>
			<fields>
				<field id="applicationsolutions_list" xsi:type="AttributeLinkedSet" _delta="redefine">
					<linked_class>ApplicationSolution</linked_class>
					<ext_key_to_me>businessprocess_id</ext_key_to_me>
				</field>
			</fields>
			<presentation>
				<details>
					<items>
						<item id="contacts_list" _delta="redefine">
							<rank>80</rank>
						</item>
						<item id="documents_list" _delta="redefine">
							<rank>100</rank>
						</item>
						<item id="applicationsolutions_list" _delta="redefine">
							<rank>70</rank>
						</item>					
					</items>
				</details>
			</presentation>
		</class>
		<class id="ApplicationSolution">
			<properties>
				<naming>
					<attributes _delta="redefine">
						<attribute id="businessprocess_name"/>
						<attribute id="name"/>
					</attributes>
				</naming>
				<icon _delta="redefine">../le-config-mgmt/images/app.png</icon>
			</properties>
			<fields>
				<field id="businessprocess_id" xsi:type="AttributeExternalKey" _delta="define">
					<sql>businessprocess_id</sql>
					<target_class>BusinessProcess</target_class>
					<is_null_allowed>false</is_null_allowed>
					<on_target_delete>DEL_MANUAL</on_target_delete>
				</field>
				<field id="businessprocess_name" xsi:type="AttributeExternalField" _delta="define">
					<extkey_attcode>businessprocess_id</extkey_attcode>
					<target_attcode>name</target_attcode>
				</field>
				<field id="contact_list_custom" xsi:type="AttributeLinkedSetIndirect" _delta="define">
					<linked_class>lnkContactToApplicationSolution</linked_class>
					<ext_key_to_me>applicationsolution_id</ext_key_to_me>
					<count_min>0</count_min>
					<count_max>0</count_max>
					<ext_key_to_remote>contact_id</ext_key_to_remote>
					<duplicates/>
				</field>
				<field id="name_cn" xsi:type="AttributeString" _delta="define">
					<sql>name_cn</sql>
					<default_value/>
					<is_null_allowed>true</is_null_allowed>
				</field>
				<field id="url_list" xsi:type="AttributeLinkedSet" _delta="define">
					<linked_class>Url</linked_class>
					<ext_key_to_me>applicationsolution_id</ext_key_to_me>
				</field>
				<field id="status" xsi:type="AttributeEnum" _delta="redefine">
					<values>
						<value id="production">production</value>
						<value id="implementation">implementation</value>
						<value id="stock">stock</value>
						<value id="obsolete">obsolete</value>
					</values>
					<sql>status</sql>
					<default_value>production</default_value>
					<is_null_allowed>true</is_null_allowed>
					<display_style>list</display_style>					
				</field>
				<field id="type" xsi:type="AttributeEnum" _delta="define">
					<values>
						<value id="web">web</value>
						<value id="other">other</value>
						<value id="shadowlink">shadowlink</value>
					</values>
					<sql>type</sql>
					<default_value>web</default_value>
					<is_null_allowed>true</is_null_allowed>
					<display_style>list</display_style>					
				</field>
			</fields>
			<presentation>
				<details>
					<items>
						<item id="contacts_list" _delta="delete"></item>
						<item id="contact_list_custom" _delta="define">
							<rank>70</rank>
						</item>
						<item id="url_list" _delta="define">
							<rank>80</rank>
						</item>
						<item id="name_cn" _delta="define">
							<rank>15</rank>
						</item>
						<item id="type" _delta="define">
							<rank>16</rank>
						</item>
						<item id="businessprocess_id" _delta="define">
							<rank>16</rank>
						</item>

					</items>
				</details>
				<search>
					<items>
						<item id="name_cn" _delta="define">
							<rank>15</rank>
						</item>
						<item id="type" _delta="define">
							<rank>16</rank>
						</item>						
						<item id="status" _delta="define">
							<rank>20</rank>
						</item>
						<item id="businessprocess_id" _delta="define">
							<rank>16</rank>
						</item>
					</items>

				</search>
				<list>
					<items>
						<item id="name_cn" _delta="define">
							<rank>5</rank>
						</item>
						<item id="type" _delta="define">
							<rank>16</rank>
						</item>						
						<item id="status" _delta="define">
							<rank>10</rank>
						</item>
						<item id="ci_id">
							<rank>100</rank>
						</item>
						<item id="businessprocess_id" _delta="define">
							<rank>6</rank>
						</item>
					</items>

				</list>
			</presentation>
			<relations>
				<relation id="impacts">
					<neighbours>
						<neighbour id="businessprocess" _delta="redefine">
							<attribute>businessprocess_id</attribute>
						</neighbour>
						<neighbour id="contact_custom" _delta="define">
							<attribute>contact_list_custom</attribute>
						</neighbour>
					</neighbours>
				</relation>
			</relations>
			<methods>
				<method id="isAllowedCreationCustom" _delta="define">
					<static>false</static>
					<access>public</access>
					<type>Custom</type>
					<code><![CDATA[
						public function isAllowedCreationCustom()
						{
							if($this->IsNew() && !UserRights::IsAdministrator())
							{
								return(false);
							}else
							{
								return(true);
							}
						}
					]]>
					</code>
				</method>
				<method id="isAllowedModifyCustom" _delta="define">
					<static>false</static>
					<access>public</access>
					<type>Custom</type>
					<code><![CDATA[
						public function isAllowedModifyCustom()
						{
							$iKey = $this->GetKey();
							if($iKey < 0 && !UserRights::IsAdministrator())
							{
								return(false);
							}
							$iObj = NULL;
							$iUserID = UserRights::GetContactId();
							if($iUserID>0)
							{
								$oql = "SELECT lnkContactToApplicationSolution AS l WHERE l.contact_id = $iUserID AND l.applicationsolution_id = $iKey";
								$iObj = MetaModel::GetObjectFromOQL($oql);
							}

							if (!$iObj && !UserRights::IsAdministrator() && !UserRights::HasProfile("产品经理"))
							{
								return(false);
							}else
							{
								return(true);
							}
						}
					]]>
					</code>
				</method>
				<method id="ReloadAndDisplayCustom" _delta="define">
					<static>false</static>
					<access>public</access>
					<type>Custom</type>
					<code><![CDATA[
					function ReloadAndDisplayCustom($oPage, $oObj, $sMessageId = '', $sMessage = '', $sSeverity = null)
					{
						$oAppContext = new ApplicationContext();
						if ($sMessageId != '')
						{
							cmdbAbstractObject::SetSessionMessage(get_class($oObj), $oObj->GetKey(), $sMessageId, $sMessage, $sSeverity, 0, true /* must not exist */);
						}
						
						$oId = $oObj->getKey();
						$oPage->add_header('Location: '.utils::GetAbsoluteUrlAppRoot().'pages/UI.php?operation=details&class='.get_class($oObj).'&id='.$oId.'&'.$oAppContext->GetForLink());
					}
					]]>
					</code>
				</method>
				
				<method id="DisplayModifyForm" _delta="define">
					<static>false</static>
					<access>public</access>
					<type>Overload-cmdbAbstractObject</type>
					<code><![CDATA[
						public function DisplayModifyForm(WebPage $oPage, $aExtraParams = array())
						{
							if(!self::isAllowedCreationCustom())
							{
								$sMesg = Dict::Format("Class:ApplicationSolution/Error:NotAllowNew", get_class($this));
								$sMesg = $sMesg . "...<a href=\"".utils::GetAbsoluteUrlAppRoot()."pages/UI.php?c%5Bmenu%5D=ApplicationSolution\">" . Dict::Format("Class:ApplicationSolution/Msg:ReturnList")."</a>";
								$oPage->add("<div class=\"header_message message_info\">$sMesg</div>\n");
								//self::ReloadAndDisplayCustom($oPage, $this, 'app-create-not-allowd', $sMesg, 'info');
							}elseif(!self::isAllowedModifyCustom())
							{
								$sMesg = Dict::Format("Class:ApplicationSolution/Error:CanOnlyUpdateAppYourself", $this->Get('friendlyname'));
								//$oPage->add("<div class=\"header_message message_info\">$sMesg</div>\n");
								self::ReloadAndDisplayCustom($oPage, $this, 'app-modify-not-allowd', $sMesg, 'info');
							}
							else
							{
								parent::DisplayModifyForm($oPage, $aExtraParams);
							}
						}
					]]>
					</code>
				</method>
				<method id="DisplayBareRelations" _delta="define">
					<static>false</static>
					<access>public</access>
					<type>Overload-cmdbAbstractObject</type>
					<code><![CDATA[	  public function DisplayBareRelations(WebPage $oPage, $bEditMode = false)
					{
						parent::DisplayBareRelations($oPage, $bEditMode);
						
						$grafana = trim(MetaModel::GetModuleSetting('le-config-mgmt', 'grafana_app_url', 'http://localhost/'));
						$app = $this->Get('name');
						$tabUrl = $grafana . "?var-app=$app.8080";
						$iframe_start = '<iframe style="border:0;padding:0;margin:0;width:100%;height:500px;overflow:auto" ';
						$iframe_end = '</iframe></div>';
						$addStr = $iframe_start . 'src=' . '"' . $tabUrl . '"' . '>' . $iframe_end;
						if (!$bEditMode)
						{
							$oPage->SetCurrentTab('监控');
							$oPage->add('<div id="grafana_app_url" style="width:100%;height:500px;">');
							$oPage->add($addStr);
						}
					}]]></code>
				</method>
				<method id="GetAttributeFlags" _delta="define">
					<static>false</static>
					<access>public</access>
					<type>Overload-iDisplay</type>
					<code><![CDATA[
					// 用DisplayModifyForm控制页面跳转，配合DoCheckToWrite已经能很好的保证权限控制。
					// GetAttributeFlags已经不会起作用了。保留作为其他场景下的参考代码。
					public function GetAttributeFlags($sAttCode, &$aReasons = array(), $sTargetState = '')
					{
						if (!self::isAllowedModifyCustom())
						{
							return OPT_ATT_READONLY;
						}
						else
						{
							return parent::GetAttributeFlags($sAttCode, $aReasons, $sTargetState);
						}
					}
					]]>
					</code>
				</method>
				<method id="DoCheckToWrite" _delta="define">
					<static>false</static>
					<access>protected</access>
					<type>Overload-DBObject</type>
					<code><![CDATA[	   public function DoCheckToWrite()
					{
						parent::DoCheckToWrite();
						if(!self::isAllowedCreationCustom())
						{
							$this->m_aCheckIssues[] = Dict::Format("Class:ApplicationSolution/Error:NotAllowNew");
						}
						if(!self::isAllowedModifyCustom())
						{
							$this->m_aCheckIssues[] = Dict::Format("Class:ApplicationSolution/Error:CanOnlyUpdateAppYourself", $this->Get('friendlyname'));
						}
					}
					]]>
					</code>
				</method>
			</methods>		
		</class>
		<class id="PhysicalDevice">
			<fields>
				<field id="hostname" xsi:type="AttributeString" _delta="define">
					<sql>hostname</sql>
					<default_value/>
					<is_null_allowed>true</is_null_allowed>
				</field>
				<field id="location_id" xsi:type="AttributeExternalKey" _delta="redefine">
					<sql>location_id</sql>
					<target_class>Location</target_class>
					<is_null_allowed>true</is_null_allowed>
					<on_target_delete>DEL_MANUAL</on_target_delete>
					<allow_target_creation>false</allow_target_creation>

				</field>
			</fields>

			<presentation>
				<list>
					<items>
						<item id="serialnumber" _delta="delete"></item>
						<item id="brand_id" _delta="delete"></item>
						<item id="business_criticity" _delta="delete"></item>
					</items>
				</list>
			</presentation>
		</class>
		<class id="Server">
			<properties>
				<naming _delta="redefine">
					<attributes>
						<attribute id="hostname"/>
					</attributes>
				</naming>
				<reconciliation _delta="redefine">
					<attributes>
						<attribute id="name"/>
						<attribute id="hostname"/>
						<attribute id="org_id"/>
						<attribute id="organization_name"/>
					</attributes>
				</reconciliation>
			</properties>
			<fields>
				<field id="cluster_list" xsi:type="AttributeLinkedSetIndirect" _delta="define">
					<linked_class>lnkServerToCluster</linked_class>
					<ext_key_to_me>server_id</ext_key_to_me>
					<ext_key_to_remote>cluster_id</ext_key_to_remote>
					<count_max>0</count_max>
					<count_min>0</count_min>
					<duplicates/>
				</field>
				<field id="vip_list" xsi:type="AttributeLinkedSetIndirect" _delta="define">
					<linked_class>lnkServerToVirtualIP</linked_class>
					<ext_key_to_me>server_id</ext_key_to_me>
					<ext_key_to_remote>vip_id</ext_key_to_remote>
					<count_max>0</count_max>
					<count_min>0</count_min>
					<duplicates/>
				</field>
				<field id="database_list" xsi:type="AttributeLinkedSetIndirect" _delta="define">
					<linked_class>lnkDatabaseToServer</linked_class>
					<ext_key_to_me>server_id</ext_key_to_me>
					<count_min>0</count_min>
					<count_max>0</count_max>
					<ext_key_to_remote>database_id</ext_key_to_remote>
					<duplicates/>				
				</field>
				<field id="ip_list" xsi:type="AttributeLinkedSet" _delta="define">
					<linked_class>PhysicalIP</linked_class>
					<ext_key_to_me>connectableci_id</ext_key_to_me>
					<count_min>0</count_min>
					<count_max>0</count_max>
					<duplicates/>
				</field>
				<field id="all_ip" xsi:type="AttributeString" _delta="define">
					<sql>all_ip</sql>
					<default_value/>
					<is_null_allowed>true</is_null_allowed>
				</field>
			</fields>
			<presentation>
				<details>
					<items>
						<item id="providercontracts_list" _delta="delete"></item>
						<item id="services_list" _delta="delete"></item>
						<item id="ip_list" _delta="define">
							<rank>4</rank>
						</item>
						<item id="cluster_list" _delta="define">
							<rank>5</rank>
						</item>
						<item id="vip_list" _delta="define">
							<rank>6</rank>
						</item>
						<item id="database_list">
							<rank>8</rank>
						</item>
						<item id="documents_list" _delta="redefine">
							<rank>100</rank>
						</item>
						<item id="col:col1">
							<rank>120</rank>
							<items>
								<item id="fieldset:Server:baseinfo" _delta="redefine">
									<rank>10</rank>
									<items>
										<item id="name">
											<rank>10</rank>
										</item>
										<item id="hostname">
											<rank>20</rank>
										</item>
										<item id="org_id">
											<rank>30</rank>
										</item>
										<item id="status">
											<rank>40</rank>
										</item>
										<item id="business_criticity">
											<rank>50</rank>
										</item>

										<item id="cpu">
											<rank>80</rank>
										</item>
										<item id="ram">
											<rank>90</rank>
										</item>

									</items>
								</item>
								<item id="fieldset:Server:moreinfo" _delta="redefine">
									<rank>20</rank>
									<items>
										<item id="location_id">
											<rank>60</rank>
										</item>
										<item id="rack_id">
											<rank>61</rank>
										</item>
										<item id="brand_id">
											<rank>10</rank>
										</item>
										<item id="model_id">
											<rank>20</rank>
										</item>
										<item id="osfamily_id">
											<rank>30</rank>
										</item>
										<item id="osversion_id">
											<rank>40</rank>
										</item>
										<item id="oslicence_id">
											<rank>50</rank>
										</item>
									</items>
								</item>
							</items>
						</item>
						<item id="col:col2">
							<rank>130</rank>
							<items>
								<item id="fieldset:Server:Date">
									<rank>10</rank>
									<items>
										<item id="move2production">
											<rank>10</rank>
										</item>
										<item id="purchase_date">
											<rank>20</rank>
										</item>
										<item id="end_of_warranty">
											<rank>30</rank>
										</item>
									</items>
								</item>
								<item id="fieldset:Server:power" _delta="delete"></item>

								<item id="fieldset:Server:otherinfo">
									<rank>30</rank>
									<items>
										<item id="description">
											<rank>10</rank>
										</item>
									</items>
								</item>
							</items>
						</item>
					</items>
				</details>
				<search _delta="redefine">
					<items>
						<item id="name">
							<rank>1</rank>
						</item>

						<item id="hostname">
							<rank>20</rank>
						</item>
						<item id="all_ip">
							<rank>25</rank>
						</item>
						<item id="org_id">
							<rank>30</rank>
						</item>
						<item id="status">
							<rank>40</rank>
						</item>
						<item id="business_criticity">
							<rank>50</rank>
						</item>
						<item id="location_id">
							<rank>51</rank>
						</item>
						<item id="rack_id">
							<rank>52</rank>
						</item>

						<item id="managementip">
							<rank>55</rank>
						</item>
						<item id="brand_id">
							<rank>60</rank>
						</item>
						<item id="model_id">
							<rank>70</rank>
						</item>
						<item id="move2production">
							<rank>120</rank>
						</item>
					</items>
				</search>
				<list _delta="redefine">
					<items>
						<item id="ci_id">
							<rank>100</rank>
						</item>					
						<item id="all_ip">
							<rank>25</rank>
						</item>

						<item id="cpu">
							<rank>3</rank>
						</item>
						<item id="ram">
							<rank>5</rank>
						</item>

						<item id="status">
							<rank>21</rank>
						</item>

						<item id="rack_id">
							<rank>40</rank>
						</item>
						<item id="model_id">
							<rank>60</rank>
						</item>
						<item id="org_id">
							<rank>70</rank>
						</item>
					</items>
				</list>
			</presentation>
			<relations>
				<relation id="impacts" _delta="define">
					<neighbours>
						<neighbour id="cluster">
							<attribute>cluster_list</attribute>
						</neighbour>
						<neighbour id="database_list" _delta="define">
							<attribute>database_list</attribute>							
						</neighbour>						
					</neighbours>
				</relation>
			</relations>

		</class>

		<class id="IPAddress" _delta="define">
			<parent>cmdbAbstractObject</parent>
			<properties>
				<category>bizmodel,searchable</category>
				<abstract>true</abstract>
				<key_type>autoincrement</key_type>
				<db_table>ipaddress</db_table>
				<db_key_field>id</db_key_field>
				<db_final_class_field>finalclass</db_final_class_field>
				<naming>
					<attributes>
						<attribute id="ipaddress"/>
					</attributes>
				</naming>
				<display_template/>
				<icon>images/interface.png</icon>
				<reconciliation>
					<attributes>
						<attribute id="ipaddress"/>
					</attributes>
				</reconciliation>
			</properties>
			<fields>
				<field id="ipaddress" xsi:type="AttributeIPAddress">
					<sql>ipaddress</sql>
					<default_value/>
					<is_null_allowed>false</is_null_allowed>
				</field>
				<field id="type" xsi:type="AttributeEnum">
					<values>
						<value id="int">int</value>
						<value id="ext">ext</value>
						<value id="oob">oob</value>
					</values>
					<sql>type</sql>
					<default_value>int</default_value>
					<is_null_allowed>true</is_null_allowed>
					<display_style>list</display_style>
				</field>
				<field id="comment" xsi:type="AttributeText">
					<sql>comment</sql>
					<default_value/>
					<is_null_allowed>true</is_null_allowed>
				</field>
			</fields>
			<methods>
				<method id="DoCheckToWrite" _delta="define">
					<static>false</static>
					<access>protected</access>
					<type>Overload-DBObject</type>
					<code><![CDATA[	   public function DoCheckToWrite()
		{
		
			parent::DoCheckToWrite();
			// ipaddress has to be unique! Currently it' not possible to define this in datamodel (xml)

			$aChanges = $this->ListChanges();
			if (array_key_exists('ipaddress', $aChanges))
			{
				$sIPAddress = $aChanges['ipaddress'];
				$oSearch = DBObjectSearch::FromOQL_AllData("SELECT IPAddress WHERE ipaddress=:ipaddress");
				$oSet = new DBObjectSet($oSearch, array(), array('ipaddress' => $sIPAddress));
				if ($oSet->Count() > 0)
				{
					$this->m_aCheckIssues[] = Dict::Format("Class:IPAddress/Error:IPAddressMustBeUnique", $sIPAddress);
				}
			}

			$finalclass = $this->Get('finalclass');

			if($finalclass == "PhysicalIP" && count($aChanges)>0)
			{
				$connectableci_id = $this->Get('connectableci_id');
				if($this->IsNew()){
					$newIP = $aChanges['type'] . "-" . $aChanges['ipaddress'];
					$old_connectableci_id = $connectableci_id;
				}
				else{
					$old_connectableci_id = $this->GetOriginal('connectableci_id');
					$this->DBWrite();
				}
				
				//$str = $old_connectableci_id . "#" . $connectableci_id;
				//$this->m_aCheckIssues[] = Dict::Format("Class:IPAddress/Error:ID", $str);
				
				$nSearch = DBObjectSearch::FromOQL_AllData("SELECT PhysicalIP WHERE connectableci_id=:connectableci_id");
				
				//connectableci_id 变化时，需要更新原connectableci_id设备的all_ip
				if($old_connectableci_id != $connectableci_id) {
					$oSet = new DBObjectSet($nSearch, array(), array('connectableci_id' => $old_connectableci_id));
					$oArray = $oSet->ToArrayOfValues();
					$oips = array();
					foreach($oArray as $value) {
						array_push($oips, $value['PhysicalIP.type'] . "-" . $value['PhysicalIP.ipaddress']);
					}
					$oipStr = implode(";", $oips);
					$oS = MetaModel::GetObjectByColumn("Server", "id", $old_connectableci_id);
					$oS->Set("all_ip", $oipStr);
					$oS->DBWrite();
					//print_r($oS->GetAsCSV("all_ip"));
				}
				$nSet = new DBObjectSet($nSearch, array(), array('connectableci_id' => $connectableci_id));
				$nArray = $nSet->ToArrayOfValues();
				$ips = array();
				if(isset($newIP)){
					array_push($ips, $newIP);
				}
				foreach($nArray as $value) {
					array_push($ips, $value['PhysicalIP.type'] . "-" . $value['PhysicalIP.ipaddress']);
				}   
				$aS =  MetaModel::GetObjectByColumn("Server", "id", $connectableci_id);
				$ipStr = implode(";", array_unique($ips));
				$aS->Set("all_ip", $ipStr);
				//$aS->UpdateObjectFromArray(array("all_ip" => $ips));
				//print_r($aS->GetAsCSV("all_ip"));
				$aS->DBWrite();
			}
		}]]>
					</code>
				</method>

			</methods>

			<presentation>
				<details>
					<items>
						<item id="ipaddress">
							<rank>10</rank>
						</item>
						<item id="type">
							<rank>15</rank>
						</item>
						<item id="comment">
							<rank>40</rank>
						</item>
					</items>
				</details>
				<search>
					<items>
						<item id="ipaddress">
							<rank>10</rank>
						</item>
						<item id="type">
							<rank>15</rank>
						</item>
						<item id="comment">
							<rank>40</rank>
						</item>
					</items>
				</search>
				<list>
					<items>
						<item id="type">
							<rank>15</rank>
						</item>						
						<item id="comment">
							<rank>40</rank>
						</item>
					</items>
				</list>
			</presentation>
		</class>

		<class id="PhysicalIP" _delta="define">
			<parent>IPAddress</parent>
			<properties>
				<category>bizmodel,searchable</category>
				<abstract>false</abstract>
				<key_type>autoincrement</key_type>
				<db_table>physicalip</db_table>
				<db_key_field>id</db_key_field>
				<db_final_class_field/>
				<naming>
					<attributes>
						<attribute id="ipaddress"/>
					</attributes>
				</naming>
				<display_template/>
				<icon>images/interface.png</icon>
				<reconciliation>
					<attributes>
						<attribute id="ipaddress"/>
						<attribute id="connectableci_id"/>
						<attribute id="connectableci_name"/>
					</attributes>
				</reconciliation>
			</properties>
			<fields>
				<field id="connectableci_id" xsi:type="AttributeExternalKey">
					<sql>connectableci_id</sql>
					<target_class>ConnectableCI</target_class>
					<is_null_allowed>false</is_null_allowed>
					<on_target_delete>DEL_AUTO</on_target_delete>
				</field>
				<field id="connectableci_name" xsi:type="AttributeExternalField">
					<extkey_attcode>connectableci_id</extkey_attcode>
					<target_attcode>name</target_attcode>
				</field>
			</fields>
			<methods></methods>
			<presentation>
				<details>
					<items>
						<item id="connectableci_id">
							<rank>20</rank>
						</item>
						<item id="ipaddress">
							<rank>10</rank>
						</item>
						<item id="type">
							<rank>15</rank>
						</item>						
						<item id="comment">
							<rank>50</rank>
						</item>
					</items>
				</details>
				<search>
					<items>
						<item id="ipaddress">
							<rank>10</rank>
						</item>
						<item id="type">
							<rank>15</rank>
						</item>
						<item id="connectableci_id">
							<rank>15</rank>
						</item>


					</items>
				</search>
				<list>
					<items>
						<item id="ipaddress">
							<rank>5</rank>
						</item>
						<item id="type">
							<rank>10</rank>
						</item>
						<item id="connectableci_id">
							<rank>20</rank>
						</item>
						<item id="comment">
							<rank>30</rank>
						</item>
					</items>
				</list>
			</presentation>			
		</class>

		<class id="VirtualIP" _delta="define">
			<parent>IPAddress</parent>
			<properties>
				<category>bizmodel,searchable</category>
				<abstract>false</abstract>
				<key_type>autoincrement</key_type>
				<db_table>virtualip</db_table>
				<db_key_field>id</db_key_field>
				<db_final_class_field/>
				<naming>
					<attributes>
						<attribute id="ipaddress"/>
					</attributes>
				</naming>
				<display_template/>
				<icon>images/interface.png</icon>
				<reconciliation>
					<attributes>
						<attribute id="ipaddress"/>
						<attribute id="connectableci_id"/>
						<attribute id="connectableci_name"/>
						<attribute id="isp_id"/>
						<attribute id="isp_name"/>
					</attributes>
				</reconciliation>
			</properties>
			<fields>
				<field id="connectableci_id" xsi:type="AttributeExternalKey">
					<sql>connectableci_id</sql>
					<target_class>Cluster</target_class>
					<is_null_allowed>false</is_null_allowed>
					<on_target_delete>DEL_AUTO</on_target_delete>
				</field>
				<field id="connectableci_name" xsi:type="AttributeExternalField">
					<extkey_attcode>connectableci_id</extkey_attcode>
					<target_attcode>name</target_attcode>
				</field>
				<field id="isp_id" xsi:type="AttributeExternalKey">
					<sql>isp_id</sql>
					<target_class>ISP</target_class>
					<is_null_allowed>true</is_null_allowed>
					<on_target_delete>DEL_AUTO</on_target_delete>
				</field>
				<field id="isp_name" xsi:type="AttributeExternalField">
					<extkey_attcode>isp_id</extkey_attcode>
					<target_attcode>name</target_attcode>
				</field>
				<field id="server_list" xsi:type="AttributeLinkedSetIndirect" _delta="define">
					<linked_class>lnkServerToVirtualIP</linked_class>
					<ext_key_to_me>vip_id</ext_key_to_me>
					<ext_key_to_remote>server_id</ext_key_to_remote>
					<count_max>0</count_max>
					<count_min>0</count_min>
					<duplicates/>
				</field>
			</fields>
			<methods></methods>
			<presentation>
				<details>
					<items>
						<item id="server_list" _delta="define">
							<rank>10</rank>
						</item>
						<item id="connectableci_id">
							<rank>20</rank>
						</item>
						<item id="ipaddress">
							<rank>10</rank>
						</item>
						<item id="type">
							<rank>15</rank>
						</item>

						<item id="isp_id">
							<rank>30</rank>
						</item>
						<item id="comment">
							<rank>50</rank>
						</item>
					</items>
				</details>
				<search>
					<items>
						<item id="ipaddress">
							<rank>10</rank>
						</item>
						<item id="type">
							<rank>15</rank>
						</item>

						<item id="connectableci_id">
							<rank>20</rank>
						</item>
						<item id="isp_id">
							<rank>30</rank>
						</item>
					</items>
				</search>
				<list>
					<items>
						<item id="ipaddress">
							<rank>5</rank>
						</item>
						<item id="type">
							<rank>10</rank>
						</item>

						<item id="connectableci_id">
							<rank>11</rank>
						</item>
						<item id="isp_id">
							<rank>20</rank>
						</item>
						<item id="comment">
							<rank>30</rank>
						</item>
					</items>
				</list>
			</presentation>

		</class>
		<class id="Domain" _delta="define">
			<parent>FunctionalCI</parent>
			<properties>
				<category>bizmodel,searchable</category>
				<abstract>false</abstract>
				<key_type>autoincrement</key_type>
				<db_table>domain</db_table>
				<db_key_field>id</db_key_field>
				<db_final_class_field/>
				<naming>
					<attributes _delta="define">
						<attribute id="name"/>
					</attributes>
				</naming>
				<display_template/>
				<icon>images/domain.png</icon>
				<reconciliation>
					<attributes _delta="redefine">
						<attribute id="name"/>
						<attribute id="org_id"/>
						<attribute id="organization_name"/>
					</attributes>
				</reconciliation>
			</properties>
			<fields>
				<field id="status" xsi:type="AttributeEnum">
					<values>
						<value id="production">production</value>
						<value id="implementation">implementation</value>
						<value id="stock">stock</value>
						<value id="obsolete">obsolete</value>
					</values>
					<sql>status</sql>
					<default_value>production</default_value>
					<is_null_allowed>true</is_null_allowed>
					<display_style>list</display_style>
				</field>
				<field id="record_id" xsi:type="AttributeExternalKey" _delta="define">
					<sql>record_id</sql>
					<is_null_allowed>true</is_null_allowed>
					<on_target_delete>DEL_AUTO</on_target_delete>
					<target_class>Cluster</target_class>
					<filter>SELECT Cluster AS c WHERE c.type = 'Router'</filter>
				</field>
				<field id="record_name" xsi:type="AttributeExternalField" _delta="define">
					<extkey_attcode>record_id</extkey_attcode>
					<target_attcode>name</target_attcode>
				</field>
			</fields>
			<methods/>
			<presentation>
				<details _delta="redefine">
					<items>
						<item id="name">
							<rank>10</rank>
						</item>
						<item id="status">
							<rank>15</rank>
						</item>
						<item id="record_id" _delta="define">
							<rank>16</rank>
						</item>
						<item id="applicationsolution_list">
							<rank>90</rank>
						</item>
						<item id="contacts_list">
							<rank>95</rank>
						</item>
						<item id="org_id">
							<rank>20</rank>
						</item>
						<item id="business_criticity">
							<rank>40</rank>
						</item>
						<item id="move2production">
							<rank>100</rank>
						</item>
						<item id="description">
							<rank>130</rank>
						</item>
						<item id="documents_list">
							<rank>150</rank>
						</item>
					</items>
				</details>
				<search _delta="redefine">
					<items>
						<item id="name">
							<rank>10</rank>
						</item>
						<item id="status">
							<rank>15</rank>
						</item>
						<item id="record_id" _delta="define">
							<rank>16</rank>
						</item>
						<item id="org_id">
							<rank>20</rank>
						</item>
						<item id="business_criticity">
							<rank>40</rank>
						</item>
						<item id="move2production">
							<rank>100</rank>
						</item>
					</items>
				</search>
				<list _delta="redefine">
					<items>
						<item id="ci_id">
							<rank>100</rank>
						</item>					
						<item id="name">
							<rank>10</rank>
						</item>
						<item id="status">
							<rank>15</rank>
						</item>
						<item id="record_id" _delta="define">
							<rank>16</rank>
						</item>						
						<item id="contacts">
							<rank>19</rank>
						</item>
						<item id="org_id">
							<rank>20</rank>
						</item>
						<item id="business_criticity">
							<rank>40</rank>
						</item>
					</items>
				</list>
			</presentation>
		</class>
		<class id="Cluster" _delta="define">
			<parent>FunctionalCI</parent>
			<properties>
				<category>bizmodel,searchable</category>
				<abstract>false</abstract>
				<key_type>autoincrement</key_type>
				<db_table>cluster</db_table>
				<db_key_field>id</db_key_field>
				<db_final_class_field/>
				<naming>
					<attributes>
						<attribute id="name"/>
					</attributes>
				</naming>
				<display_template/>
				<icon>images/cluster.png</icon>
				<reconciliation>
					<attributes>
						<attribute id="name"/>
						<attribute id="org_id"/>
						<attribute id="organization_name"/>
					</attributes>
				</reconciliation>
			</properties>
			<fields>
				<field id="status" xsi:type="AttributeEnum">
					<values>
						<value id="production">production</value>
						<value id="implementation">implementation</value>
						<value id="stock">stock</value>
						<value id="obsolete">obsolete</value>
					</values>
					<sql>status</sql>
					<default_value>production</default_value>
					<is_null_allowed>true</is_null_allowed>
					<display_style>list</display_style>
				</field>
				<field id="server_list" xsi:type="AttributeLinkedSetIndirect" _delta="define">
					<linked_class>lnkServerToCluster</linked_class>
					<ext_key_to_me>cluster_id</ext_key_to_me>
					<ext_key_to_remote>server_id</ext_key_to_remote>
					<count_max>0</count_max>
					<count_min>0</count_min>
					<duplicates/>
				</field>
				<field id="vip_list" xsi:type="AttributeLinkedSet" _delta="define">
					<linked_class>VirtualIP</linked_class>
					<ext_key_to_me>connectableci_id</ext_key_to_me>
					<edit_mode>add_only</edit_mode>
					<count_min>0</count_min>
					<count_max>0</count_max>
					<duplicates/>
				</field>
				<field id="type" xsi:type="AttributeEnum" _delta="define">
					<values>
						<value id="compute">Compute</value>
						<value id="router">Router</value>
						<value id="dev">Dev</value>
						<value id="qa">QA</value>
						<value id="ops">OPS</value>
					</values>
					<sql>type</sql>
					<default_value>OPS</default_value>
				</field>
				<field id="domain_list" xsi:type="AttributeLinkedSet" _delta="define">
					<linked_class>Domain</linked_class>
					<ext_key_to_me>record_id</ext_key_to_me>
					<edit_mode>add_only</edit_mode>
					<count_max>0</count_max>
					<count_min>0</count_min>
					<duplicates/>
				</field>
				<field id="cname" xsi:type="AttributeString" _delta="define">
					<sql>cname</sql>
					<default_value/>
					<is_null_allowed>true</is_null_allowed>
				</field>
			</fields>
			<methods/>
			<presentation>
				<details>
					<items>
						<item id="vip_list" _delta="define">
							<rank>5</rank>
						</item>
						<item id="domain_list" _delta="define">
							<rank>6</rank>
						</item>
						<item id="server_list">
							<rank>10</rank>
						</item>
						<item id="name">
							<rank>10</rank>
						</item>
						<item id="type" _delta="define">
							<rank>11</rank>
						</item>
						<item id="org_id">
							<rank>20</rank>
						</item>
						<item id="status">
							<rank>30</rank>
						</item>
						<item id="cname" _delta="define">
							<rank>35</rank>
						</item>
						<item id="applicationsolution_list">
							<rank>90</rank>
						</item>

						<item id="business_criticity">
							<rank>40</rank>
						</item>
						<item id="move2production">
							<rank>100</rank>
						</item>
						<item id="description">
							<rank>130</rank>
						</item>
						<item id="contacts_list">
							<rank>140</rank>
						</item>
						<item id="documents_list">
							<rank>150</rank>
						</item>
					</items>
				</details>
				<search>
					<items>
						<item id="name">
							<rank>10</rank>
						</item>
						<item id="type" _delta="define">
							<rank>11</rank>
						</item>						
						<item id="org_id">
							<rank>20</rank>
						</item>
						<item id="status">
							<rank>30</rank>
						</item>
						<item id="business_criticity">
							<rank>40</rank>
						</item>
						<item id="move2production">
							<rank>100</rank>
						</item>
					</items>
				</search>
				<list>
					<items>
						<item id="ci_id">
							<rank>100</rank>
						</item>					
						<item id="name">
							<rank>10</rank>
						</item>
						<item id="type" _delta="define">
							<rank>11</rank>
						</item>						
						<item id="org_id">
							<rank>20</rank>
						</item>
						<item id="status">
							<rank>30</rank>
						</item>
						<item id="business_criticity">
							<rank>40</rank>
						</item>
					</items>
				</list>
			</presentation>
		</class>

		<class id="Database" _delta="define">
			<parent>FunctionalCI</parent>
			<properties>
				<category>bizmodel,searchable</category>
				<abstract>true</abstract>
				<key_type>autoincrement</key_type>
				<db_table>database</db_table>
				<db_key_field>id</db_key_field>
				<db_final_class_field>finalclass</db_final_class_field>
				<naming>
					<attributes _delta="define">
						<attribute id="location"/>
						<attribute id="name"/>
					</attributes>
				</naming>
				<display_template/>
				<icon>images/database.png</icon>
				<reconciliation>
					<attributes _delta="define">
						<attribute id="name"/>
						<attribute id="org_id"/>
						<attribute id="organization_name"/>
					</attributes>
				</reconciliation>
			</properties>
			<fields>
				<field id="status" xsi:type="AttributeEnum">
					<values>
						<value id="production">production</value>
						<value id="implementation">implementation</value>
						<value id="stock">stock</value>
						<value id="obsolete">obsolete</value>
					</values>
					<sql>status</sql>
					<default_value>production</default_value>
					<is_null_allowed>true</is_null_allowed>
					<display_style>list</display_style>
				</field>
				<field id="location" xsi:type="AttributeEnum">
					<values>
						<value id="china">China</value>
						<value id="us">UnitedStates</value>
						<value id="hk">HongKong</value>
						<value id="ru">Russia</value>
						<value id="in">India</value>
						<value id="other">Other</value>
					</values>
					<sql>location</sql>
					<default_value/>
					<is_null_allowed>true</is_null_allowed>
					<display_style>list</display_style>
				</field>
				<field id="info" xsi:type="AttributeText" _delta="define">
					<sql>info</sql>
					<is_null_allowed>true</is_null_allowed>
					<default_value/>
				</field>
				<field id="server_list" xsi:type="AttributeLinkedSetIndirect" _delta="define">
					<linked_class>lnkDatabaseToServer</linked_class>
					<ext_key_to_me>database_id</ext_key_to_me>
					<count_min>0</count_min>
					<count_max>0</count_max>
					<ext_key_to_remote>server_id</ext_key_to_remote>
					<duplicates/>				
				</field>
			</fields>
			<methods/>
			<presentation>
				<details _delta="redefine">
					<items>
						<item id="name">
							<rank>10</rank>
						</item>
						<item id="location">
							<rank>11</rank>
						</item>
						<item id="status">
							<rank>15</rank>
						</item>
						<item id="info">
							<rank>18</rank>
						</item>
						<item id="org_id">
							<rank>20</rank>
						</item>
						<item id="business_criticity">
							<rank>40</rank>
						</item>
						<item id="contacts_list">
							<rank>95</rank>
						</item>
						<item id="applicationsolution_list">
							<rank>90</rank>
						</item>
						<item id="server_list">
							<rank>95</rank>
						</item>
						<item id="move2production">
							<rank>100</rank>
						</item>
						<item id="description">
							<rank>130</rank>
						</item>
						<item id="documents_list">
							<rank>150</rank>
						</item>
					</items>
				</details>
				<search _delta="redefine">
					<items>
						<item id="name">
							<rank>10</rank>
						</item>
						<item id="location">
							<rank>11</rank>
						</item>

						<item id="status">
							<rank>15</rank>
						</item>
						<item id="info">
							<rank>18</rank>
						</item>

						<item id="org_id">
							<rank>20</rank>
						</item>
						<item id="business_criticity">
							<rank>40</rank>
						</item>
						<item id="move2production">
							<rank>100</rank>
						</item>
					</items>
				</search>
				<list _delta="redefine">
					<items>
						<item id="ci_id">
							<rank>100</rank>
						</item>					
						<item id="name">
							<rank>10</rank>
						</item>
						<item id="location">
							<rank>11</rank>
						</item>

						<item id="status">
							<rank>15</rank>
						</item>
						<item id="contacts">
							<rank>19</rank>
						</item>
						<item id="org_id">
							<rank>20</rank>
						</item>
						<item id="business_criticity">
							<rank>40</rank>
						</item>
					</items>
				</list>
			</presentation>
		</class>		
		<class id="RDS" _delta="define">
			<parent>Database</parent>
			<properties>
				<category>bizmodel,searchable</category>
				<abstract>false</abstract>
				<key_type>autoincrement</key_type>
				<db_table>rds</db_table>
				<db_key_field>id</db_key_field>
				<db_final_class_field/>
				<naming>
					<attributes _delta="define">
						<attribute id="location"/>
						<attribute id="name"/>
					</attributes>
				</naming>
				<display_template/>
				<icon>images/rds.png</icon>
				<reconciliation>
					<attributes _delta="define">
						<attribute id="name"/>
						<attribute id="org_id"/>
						<attribute id="organization_name"/>
					</attributes>
				</reconciliation>
			</properties>
			<fields/>
			<methods/>
			<presentation>
				<details _delta="redefine">
					<items>
						<item id="name">
							<rank>10</rank>
						</item>
						<item id="location">
							<rank>11</rank>
						</item>
						<item id="status">
							<rank>15</rank>
						</item>
						<item id="info">
							<rank>18</rank>
						</item>
						<item id="org_id">
							<rank>20</rank>
						</item>
						<item id="business_criticity">
							<rank>40</rank>
						</item>
						<item id="contacts_list">
							<rank>95</rank>
						</item>

						<item id="applicationsolution_list">
							<rank>90</rank>
						</item>

						<item id="move2production">
							<rank>100</rank>
						</item>
						<item id="description">
							<rank>130</rank>
						</item>
						<item id="documents_list">
							<rank>150</rank>
						</item>
					</items>
				</details>
				<search _delta="redefine">
					<items>
						<item id="name">
							<rank>10</rank>
						</item>
						<item id="location">
							<rank>11</rank>
						</item>

						<item id="status">
							<rank>15</rank>
						</item>
						<item id="info">
							<rank>18</rank>
						</item>

						<item id="org_id">
							<rank>20</rank>
						</item>
						<item id="business_criticity">
							<rank>40</rank>
						</item>
						<item id="move2production">
							<rank>100</rank>
						</item>
					</items>
				</search>
				<list _delta="redefine">
					<items>
						<item id="ci_id">
							<rank>100</rank>
						</item>					
						<item id="name">
							<rank>10</rank>
						</item>
						<item id="location">
							<rank>11</rank>
						</item>

						<item id="status">
							<rank>15</rank>
						</item>
						<item id="contacts">
							<rank>19</rank>
						</item>
						<item id="org_id">
							<rank>20</rank>
						</item>
						<item id="business_criticity">
							<rank>40</rank>
						</item>
					</items>
				</list>
			</presentation>
		</class>
		<class id="MySQL" _delta="define">
			<parent>Database</parent>
			<properties>
				<category>bizmodel,searchable</category>
				<abstract>false</abstract>
				<key_type>autoincrement</key_type>
				<db_table>mysql</db_table>
				<db_key_field>id</db_key_field>
				<db_final_class_field/>
				<naming>
					<attributes _delta="define">
						<attribute id="location"/>
						<attribute id="name"/>
					</attributes>
				</naming>
				<display_template/>
				<icon>images/mysql.png</icon>
				<reconciliation>
					<attributes _delta="define">
						<attribute id="name"/>
						<attribute id="org_id"/>
						<attribute id="organization_name"/>
					</attributes>
				</reconciliation>
			</properties>
			<fields/>
			<methods/>
			<presentation>
				<details _delta="redefine">
					<items>
						<item id="name">
							<rank>10</rank>
						</item>
						<item id="location">
							<rank>11</rank>
						</item>
						<item id="status">
							<rank>15</rank>
						</item>
						<item id="info">
							<rank>18</rank>
						</item>
						<item id="org_id">
							<rank>20</rank>
						</item>
						<item id="business_criticity">
							<rank>40</rank>
						</item>
						<item id="contacts_list">
							<rank>95</rank>
						</item>
						<item id="server_list">
							<rank>95</rank>
						</item>
						<item id="applicationsolution_list">
							<rank>90</rank>
						</item>

						<item id="move2production">
							<rank>100</rank>
						</item>
						<item id="description">
							<rank>130</rank>
						</item>
						<item id="documents_list">
							<rank>150</rank>
						</item>
					</items>
				</details>
				<search _delta="redefine">
					<items>
						<item id="name">
							<rank>10</rank>
						</item>
						<item id="location">
							<rank>11</rank>
						</item>

						<item id="status">
							<rank>15</rank>
						</item>
						<item id="info">
							<rank>18</rank>
						</item>

						<item id="org_id">
							<rank>20</rank>
						</item>
						<item id="business_criticity">
							<rank>40</rank>
						</item>
						<item id="move2production">
							<rank>100</rank>
						</item>
					</items>
				</search>
				<list _delta="redefine">
					<items>
						<item id="ci_id">
							<rank>100</rank>
						</item>					
						<item id="name">
							<rank>10</rank>
						</item>
						<item id="location">
							<rank>11</rank>
						</item>

						<item id="status">
							<rank>15</rank>
						</item>
						<item id="contacts">
							<rank>19</rank>
						</item>
						<item id="org_id">
							<rank>20</rank>
						</item>
						<item id="business_criticity">
							<rank>40</rank>
						</item>
					</items>
				</list>
			</presentation>
		</class>
		<class id="MongoDB" _delta="define">
			<parent>Database</parent>
			<properties>
				<category>bizmodel,searchable</category>
				<abstract>false</abstract>
				<key_type>autoincrement</key_type>
				<db_table>mongodb</db_table>
				<db_key_field>id</db_key_field>
				<db_final_class_field/>
				<naming>
					<attributes _delta="define">
						<attribute id="location"/>
						<attribute id="name"/>
					</attributes>
				</naming>
				<display_template/>
				<icon>images/mongodb.png</icon>
				<reconciliation>
					<attributes _delta="define">
						<attribute id="name"/>
						<attribute id="org_id"/>
						<attribute id="organization_name"/>
					</attributes>
				</reconciliation>
			</properties>
			<fields/>
			<methods/>
			<presentation>
				<details _delta="redefine">
					<items>
						<item id="name">
							<rank>10</rank>
						</item>
						<item id="location">
							<rank>11</rank>
						</item>
						<item id="status">
							<rank>15</rank>
						</item>
						<item id="info">
							<rank>18</rank>
						</item>
						<item id="org_id">
							<rank>20</rank>
						</item>
						<item id="business_criticity">
							<rank>40</rank>
						</item>
						<item id="contacts_list">
							<rank>95</rank>
						</item>
						<item id="server_list">
							<rank>95</rank>
						</item>
						<item id="applicationsolution_list">
							<rank>90</rank>
						</item>

						<item id="move2production">
							<rank>100</rank>
						</item>
						<item id="description">
							<rank>130</rank>
						</item>
						<item id="documents_list">
							<rank>150</rank>
						</item>
					</items>
				</details>
				<search _delta="redefine">
					<items>
						<item id="name">
							<rank>10</rank>
						</item>
						<item id="location">
							<rank>11</rank>
						</item>

						<item id="status">
							<rank>15</rank>
						</item>
						<item id="info">
							<rank>18</rank>
						</item>

						<item id="org_id">
							<rank>20</rank>
						</item>
						<item id="business_criticity">
							<rank>40</rank>
						</item>
						<item id="move2production">
							<rank>100</rank>
						</item>
					</items>
				</search>
				<list _delta="redefine">
					<items>
						<item id="ci_id">
							<rank>100</rank>
						</item>					
						<item id="name">
							<rank>10</rank>
						</item>
						<item id="location">
							<rank>11</rank>
						</item>

						<item id="status">
							<rank>15</rank>
						</item>
						<item id="contacts">
							<rank>19</rank>
						</item>
						<item id="org_id">
							<rank>20</rank>
						</item>
						<item id="business_criticity">
							<rank>40</rank>
						</item>
					</items>
				</list>
			</presentation>
		</class>
		<class id="Redis" _delta="define">
			<parent>Database</parent>
			<properties>
				<category>bizmodel,searchable</category>
				<abstract>false</abstract>
				<key_type>autoincrement</key_type>
				<db_table>redis</db_table>
				<db_key_field>id</db_key_field>
				<db_final_class_field/>
				<naming>
					<attributes _delta="define">
						<attribute id="location"/>
						<attribute id="name"/>
					</attributes>
				</naming>
				<display_template/>
				<icon>images/redis.png</icon>
				<reconciliation>
					<attributes _delta="define">
						<attribute id="name"/>
						<attribute id="org_id"/>
						<attribute id="organization_name"/>
					</attributes>
				</reconciliation>
			</properties>
			
			<fields>
				<field id="capacity" xsi:type="AttributeString" _delta="define">
					<sql>capacity</sql>
					<is_null_allowed>true</is_null_allowed>
					<default_value>2G</default_value>
				</field>
				<field id="datatype" xsi:type="AttributeString" _delta="define">
					<sql>datatype</sql>
					<is_null_allowed>true</is_null_allowed>
					<default_value/>
				</field>
				<field id="language" xsi:type="AttributeString" _delta="define">
					<sql>language</sql>
					<is_null_allowed>true</is_null_allowed>
					<default_value/>
				</field>
				<field id="type" xsi:type="AttributeEnum" _delta="define">
					<values>
						<value id="sentinel">sentinel</value>
						<value id="cluster">cluster</value>
					</values>
					<sql>type</sql>
					<default_value>cluster</default_value>
					<is_null_allowed>false</is_null_allowed>
				</field>
				<field id="persistence" xsi:type="AttributeEnum" _delta="define">
					<values>
						<value id="yes">yes</value>
						<value id="no">no</value>
					</values>
					<sql>persistence</sql>
					<default_value>yes</default_value>
					<is_null_allowed>false</is_null_allowed>
				</field>
			</fields>
			<methods/>
			<presentation>
				<details _delta="redefine">
					<items>
						<item id="name">
							<rank>10</rank>
						</item>
						<item id="location">
							<rank>11</rank>
						</item>
						<item id="status">
							<rank>12</rank>
						</item>
						<item id="capacity" _delta="define">
							<rank>13</rank>
						</item>
						<item id="datatype" _delta="define">
							<rank>14</rank>
						</item>
						<item id="language" _delta="define">
							<rank>15</rank>
						</item>
						<item id="type" _delta="define">
							<rank>16</rank>
						</item>
						<item id="persistence" _delta="define">
							<rank>17</rank>
						</item>						
						<item id="info">
							<rank>18</rank>
						</item>
						<item id="org_id">
							<rank>20</rank>
						</item>
						<item id="business_criticity">
							<rank>40</rank>
						</item>
						<item id="contacts_list">
							<rank>95</rank>
						</item>
						<item id="server_list">
							<rank>95</rank>
						</item>
						<item id="applicationsolution_list">
							<rank>90</rank>
						</item>

						<item id="move2production">
							<rank>100</rank>
						</item>
						<item id="description">
							<rank>130</rank>
						</item>
						<item id="documents_list">
							<rank>150</rank>
						</item>
					</items>
				</details>
				<search _delta="redefine">
					<items>
						<item id="name">
							<rank>10</rank>
						</item>
						<item id="location">
							<rank>11</rank>
						</item>

						<item id="status">
							<rank>12</rank>
						</item>
						<item id="capacity" _delta="define">
							<rank>13</rank>
						</item>
						<item id="datatype" _delta="define">
							<rank>14</rank>
						</item>
						<item id="language" _delta="define">
							<rank>15</rank>
						</item>
						<item id="type" _delta="define">
							<rank>16</rank>
						</item>
						<item id="persistence" _delta="define">
							<rank>17</rank>
						</item>						
						<item id="info">
							<rank>18</rank>
						</item>

						<item id="org_id">
							<rank>20</rank>
						</item>
						<item id="business_criticity">
							<rank>40</rank>
						</item>
						<item id="move2production">
							<rank>100</rank>
						</item>
					</items>
				</search>
				<list _delta="redefine">
					<items>
						<item id="ci_id">
							<rank>100</rank>
						</item>					
						<item id="name">
							<rank>10</rank>
						</item>
						<item id="location">
							<rank>11</rank>
						</item>

						<item id="status">
							<rank>12</rank>
						</item>
						<item id="capacity" _delta="define">
							<rank>13</rank>
						</item>
						<item id="datatype" _delta="define">
							<rank>14</rank>
						</item>
						<item id="language" _delta="define">
							<rank>15</rank>
						</item>
						<item id="type" _delta="define">
							<rank>16</rank>
						</item>
						<item id="persistence" _delta="define">
							<rank>17</rank>
						</item>
						
						<item id="contacts">
							<rank>19</rank>
						</item>
						<item id="org_id">
							<rank>20</rank>
						</item>
						<item id="business_criticity">
							<rank>40</rank>
						</item>
					</items>
				</list>
			</presentation>
		</class>		
		
		<class id="Url" _delta="define">
			<parent>FunctionalCI</parent>
			<properties>
				<category>bizmodel,searchable</category>
				<abstract>false</abstract>
				<key_type>autoincrement</key_type>
				<db_table>url</db_table>
				<db_key_field>id</db_key_field>
				<db_final_class_field/>
				<naming>
					<attributes _delta="define">
						<attribute id="monitor_node"/>
						<attribute id="method"/>
						<attribute id="applicationsolution_name"/>
						<attribute id="url"/>
					</attributes>
				</naming>
				<display_template/>
				<icon>images/url.png</icon>
				<reconciliation>
					<attributes _delta="define">
						<attribute id="url"/>
						<attribute id="org_id"/>
						<attribute id="organization_name"/>
					</attributes>
				</reconciliation>
			</properties>
			<fields>
				<!--
				由于参数拼接和curl命令会比较长，需要修改css/light-grey.css，添加如下代码
				table.details>tbody>tr>td.label {
					white-space:nowrap;
				}
				table.details>tbody>tr>td>div {
				  word-wrap: break-word;
				  word-break: break-all;
				}
				-->
				<field id="url" xsi:type="AttributeString" _delta="define">
					<sql>url</sql>
					<is_null_allowed>false</is_null_allowed>
					<validation_pattern>^(http|https)://[a-z0-9\-\.]+(:[0-9]+)?/((?!\?).)*$</validation_pattern>
				</field>
				<field id="applicationsolution_id" xsi:type="AttributeExternalKey">
					<sql>applicationsolution_id</sql>
					<target_class>ApplicationSolution</target_class>
					<is_null_allowed>false</is_null_allowed>
					<filter>SELECT ApplicationSolution AS app JOIN lnkContactToApplicationSolution AS l ON l.applicationsolution_id = app.id WHERE l.contact_id = :current_contact_id</filter>
					<on_target_delete>DEL_AUTO</on_target_delete>
					<allow_target_creation>false</allow_target_creation>
				</field>
				<field id="applicationsolution_name" xsi:type="AttributeExternalField">
					<extkey_attcode>applicationsolution_id</extkey_attcode>
					<target_attcode>name</target_attcode>
				</field>
				<field id="status" xsi:type="AttributeEnum">
					<values>
						<value id="production">production</value>
						<value id="stock">stock</value>
					</values>
					<sql>status</sql>
					<default_value>production</default_value>
					<is_null_allowed>true</is_null_allowed>
					<display_style>list</display_style>
				</field>
				<field id="method" xsi:type="AttributeEnum">
					<values>
						<value id="get">GET</value>
						<value id="post">POST</value>
						<value id="put">PUT</value>
						<value id="delete">DELETE</value>
						<value id="head">HEAD</value>
						<value id="propfind">PROPFIND</value>
						<value id="report">REPORT</value>
					</values>
					<sql>method</sql>
					<default_value>GET</default_value>
					<is_null_allowed>false</is_null_allowed>
					<display_style>list</display_style>
				</field>
				<field id="monitor_node" xsi:type="AttributeEnum">
					<values>
						<value id="cn">China</value>
						<value id="us">UnitedStates</value>
						<value id="hk">HongKong</value>
					</values>
					<sql>monitor_node</sql>
					<default_value>China</default_value>
					<is_null_allowed>true</is_null_allowed>
					<display_style>list</display_style>
				</field>
				<field id="headers" xsi:type="AttributeText" _delta="define">
					<sql>headers</sql>
					<is_null_allowed>true</is_null_allowed>
					<default_value/>
				</field>
				<field id="params" xsi:type="AttributeText" _delta="define">
					<sql>params</sql>
					<is_null_allowed>true</is_null_allowed>
					<default_value/>
				</field>				
				<field id="body" xsi:type="AttributeText" _delta="define">
					<sql>body</sql>
					<is_null_allowed>true</is_null_allowed>
					<default_value/>
				</field>
				<field id="require_code" xsi:type="AttributeString" _delta="define">
					<sql>require_code</sql>
					<is_null_allowed>true</is_null_allowed>
					<default_value>200</default_value>
				</field>				
				<field id="require_str" xsi:type="AttributeString" _delta="define">
					<sql>require_str</sql>
					<is_null_allowed>true</is_null_allowed>
					<default_value/>
				</field>				

				<field id="third_email" xsi:type="AttributeString">
					<sql>third_email</sql>
					<is_null_allowed>true</is_null_allowed>
					<default_value/>
					<validation_pattern>^([a-z0-9\.\-_]+@[a-z0-9-]+\.[a-z]+,)*([a-z0-9\.\-_]+@[a-z0-9-]+\.[a-z]+)$</validation_pattern>
				</field>
				<field id="third_phone" xsi:type="AttributeString">
					<sql>third_phone</sql>
					<is_null_allowed>true</is_null_allowed>
					<default_value/>
					<validation_pattern>^([0-9]{11},)*([0-9]{11})$</validation_pattern>
				</field>
				<field id="interval" xsi:type="AttributeString">
					<sql>interval</sql>
					<is_null_allowed>true</is_null_allowed>
					<default_value>20</default_value>
					<validation_pattern>^[1-9][0-9]$|^1[0-8][0-9]$</validation_pattern>
				</field>
				<field id="timeout" xsi:type="AttributeString">
					<sql>timeout</sql>
					<is_null_allowed>true</is_null_allowed>
					<default_value>3</default_value>
					<validation_pattern>^([0-9]|1[0-4])(\.[0-9]*)?$</validation_pattern>
				</field>
				<field id="failed_count" xsi:type="AttributeString">
					<sql>failed_count</sql>
					<is_null_allowed>true</is_null_allowed>
					<default_value>3</default_value>
					<validation_pattern>^[1-6]$</validation_pattern>
				</field>				
				<field id="curl" xsi:type="AttributeText">
					<sql>curl</sql>
					<is_null_allowed>true</is_null_allowed>
					<default_value/>
				</field>

			</fields>
			<lifecycle>
				<attribute>status</attribute>
				<stimuli>
					<stimulus id="ev_new" xsi:type="StimulusInternal"/>
					<stimulus id="ev_online" xsi:type="StimulusUserAction"/>
					<stimulus id="ev_offline" xsi:type="StimulusUserAction"/>
				</stimuli>
				<states>
					<state id="production">
						<flags>
							<attribute id="org_id">
								<read_only/>
							</attribute>
							<attribute id="business_criticity">
								<read_only/>
							</attribute>
							<attribute id="curl">
								<read_only/>
							</attribute>
						</flags>
						<transitions>
							<transition id="ev_offline">
								<target>stock</target>
								<actions/>
							</transition>
						</transitions>
					</state>
					<state id="stock">
						<inherit_flags_from>production</inherit_flags_from>
						<flags/>
						<transitions>
							<transition id="ev_online">
								<target>production</target>
								<actions/>
							</transition>
						</transitions>
					</state>
				</states>
			</lifecycle>
			<presentation>
				<details _delta="define">
					<items>
						<item id="col:col1">
							<rank>10</rank>
							<items>
								<item id="fieldset:Url:baseinfo">
									<rank>10</rank>
									<items>
										<item id="applicationsolution_id">
											<rank>1</rank>
										</item>
										<item id="url">
											<rank>10</rank>
										</item>
										<item id="status">
											<rank>15</rank>
										</item>
										<item id="org_id">
											<rank>20</rank>
										</item>
										<item id="business_criticity">
											<rank>40</rank>
										</item>
										<item id="move2production">
											<rank>100</rank>
										</item>
										<item id="description">
											<rank>130</rank>
										</item>
									</items>
								</item>
								<item id="fieldset:Url:moreinfo">
									<rank>20</rank>
									<items>
										<item id="method">
											<rank>18</rank>
										</item>
										<item id="headers">
											<rank>19</rank>
										</item>
										<item id="params">
											<rank>20</rank>
										</item>										
										<item id="body">
											<rank>21</rank>
										</item>
									</items>
								</item>
								<item id="fieldset:Url:monitorinfo">
									<rank>30</rank>
									<items>
										<item id="monitor_node">
											<rank>11</rank>
										</item>
										<item id="interval">
											<rank>12</rank>
										</item>
										<item id="timeout">
											<rank>13</rank>
										</item>
										<item id="require_code">
											<rank>103</rank>
										</item>
										<item id="require_str">
											<rank>104</rank>
										</item>
										<item id="third_email">
											<rank>105</rank>
										</item>
										<item id="third_phone">
											<rank>106</rank>
										</item>
									</items>
								</item>
								<item id="fieldset:Url:autocomplete">
									<rank>40</rank>
									<items>
										<item id="curl">
											<rank>200</rank>
										</item>
									</items>								
								</item>							
							</items>
						</item>
						<item id="contacts_list">
							<rank>95</rank>
						</item>
						<item id="documents_list">
							<rank>150</rank>
						</item>
					</items>
				</details>
				<search _delta="redefine">
					<items>
						<item id="applicationsolution_id">
							<rank>1</rank>
						</item>
						<item id="url">
							<rank>10</rank>
						</item>
						<item id="monitor_node">
							<rank>11</rank>
						</item>
						<item id="method">
							<rank>12</rank>
						</item>
						<item id="status">
							<rank>15</rank>
						</item>
						<item id="org_id">
							<rank>20</rank>
						</item>
						<item id="business_criticity">
							<rank>40</rank>
						</item>
						<item id="move2production">
							<rank>100</rank>
						</item>
					</items>
				</search>
				<list _delta="redefine">
					<items>
						<item id="ci_id">
							<rank>100</rank>
						</item>
						<item id="applicationsolution_id">
							<rank>10</rank>
						</item>						
						<item id="monitor_node">
							<rank>11</rank>
						</item>
						<item id="method">
							<rank>12</rank>
						</item>						
						<item id="status">
							<rank>15</rank>
						</item>
						<item id="org_id">
							<rank>20</rank>
						</item>
						<item id="business_criticity">
							<rank>40</rank>
						</item>
						<item id="move2production">
							<rank>100</rank>
						</item>						
					</items>
				</list>
			</presentation>
			<methods>
				<method id="DisplayBareRelations" _delta="define">
					<static>false</static>
					<access>public</access>
					<type>Overload-cmdbAbstractObject</type>
					<code><![CDATA[	  public function DisplayBareRelations(WebPage $oPage, $bEditMode = false)
					{
						parent::DisplayBareRelations($oPage, $bEditMode);
						
						$grafana = trim(MetaModel::GetModuleSetting('le-config-mgmt', 'grafana_url_url', 'http://localhost/'));
						$app = $this->Get('applicationsolution_name');
						$monitor_node = $this->Get('monitor_node');
						$url = urlencode($this->Get('url'));
						$method = $this->Get('method');
						$tabUrl = $grafana . "?var-monit_node=$monitor_node&var-app=$app&var-url=$url&method=$method";
						$iframe_start = '<iframe style="border:0;padding:0;margin:0;width:100%;height:500px;overflow:auto" ';
						$iframe_end = '</iframe></div>';
						$addStr = $iframe_start . 'src=' . '"' . $tabUrl . '"' . '>' . $iframe_end;
						if (!$bEditMode)
						{
							$oPage->SetCurrentTab('监控');
							$oPage->add('<div id="grafana_url_url" style="width:100%;height:500px;">');
							$oPage->add($addStr);
						}
					}]]></code>
				</method>
				<method id="ComputeValues" _delta="define">
					<static>false</static>
					<access>public</access>
					<type>Overload-DBObject</type>
					<code><![CDATA[
					public function ComputeValues()
					{
						if($this->Get('applicationsolution_id') != 0)
						{
							$app = MetaModel::GetObjectByColumn('ApplicationSolution', 'name', $this->Get('applicationsolution_name'), false);
							$this->Set("org_id", $app->Get("org_id"));
							$this->Set("business_criticity", $app->Get("business_criticity"));						
						}
						return parent::ComputeValues();
					}
					]]>
					</code>
				</method>
				<method id="CheckToDelete" _delta="define">
					<static>false</static>
					<access>protected</access>
					<type>Overload-DBObject</type>
					<code><![CDATA[	   
  	public function CheckToDelete(&$oDeletionPlan)
  	{
		$myContactId = UserRights::GetContactId();
		$appId = $this->Get('applicationsolution_id');
		$lnkFriendlyName = "$myContactId $appId";
		$lnk = MetaModel::GetObjectFromOQL("SELECT lnkContactToApplicationSolution WHERE friendlyname='$lnkFriendlyName'");
		// 普通用户不允许删除非自己名下APP的Url
		if(!$lnk && !UserRights::IsAdministrator())
		{
			$oDeletionPlan->AddToDelete($this, null);
			$oDeletionPlan->SetDeletionIssues($this, array('只能删除自己名下APP的Url'), true);
			$oDeletionPlan->ComputeResults();
			return false;
		}
		
		return parent::CheckToDelete($oDeletionPlan);
  	} 
			]]></code>
				</method>				
				<method id="DoCheckToWrite" _delta="define">
					<static>false</static>
					<access>protected</access>
					<type>Overload-DBObject</type>
					<code><![CDATA[	   public function DoCheckToWrite()
				{
					parent::DoCheckToWrite();
					
					$aChanges = $this->ListChanges();
					//检查headers字段，只允许空值和json格式的值
					if(array_key_exists('headers', $aChanges))
					{
						$sHeader = $aChanges['headers'];
						if($sHeader != "")
						{
							json_decode($sHeader);
							if(json_last_error() != JSON_ERROR_NONE)
							{
								$this->m_aCheckIssues[] = Dict::Format("Class:Url/Error:HeadersExpectJsonFormat", $sHeader);
							}
						}
					}
					// 只允许编辑自己名下APP的Url
					$myContactId = UserRights::GetContactId();
					$url = MetaModel::GetObjectByColumn("Url", "id", $this->GetKey(), false);
					
					if ($this->IsNew())
					{
						$appId = $this->Get('applicationsolution_id');
					}else
					{
						$appId = $url->Get('applicationsolution_id');
					}
					
					$lnkFriendlyName = "$myContactId $appId";
					$lnk = MetaModel::GetObjectFromOQL("SELECT lnkContactToApplicationSolution WHERE friendlyname='$lnkFriendlyName'");
					
					if(!$lnk && !UserRights::IsAdministrator())
					{
						$this->m_aCheckIssues[] = Dict::Format("Class:Url/Error:CanOnlyUpdateUrlOfYours", $myContactId);
					}
					
					// applicationsolution_id 有 filter 限制时，管理员更新Url类会导致app变化
					// 因此有了下面几行代码，但是同时也带来一个问题：管理员无法修改Url的app属性
					// 最好的方法是filter只对普通用户生效，但是iTop貌似不支持这种做法
					// 另一个解决方案是取消filter限制，但是导致用户的下拉列表有很多选项
					// 权衡中
					if(UserRights::IsAdministrator())
					{
						$this->Set('applicationsolution_id', $appId);
					}
					
					// 当用户更改APP的时候做校验是不是其他人名下的APP
					// 当然，在applicationsolution_id有filter的时候这段代码可以不要
					if(array_key_exists('applicationsolution_id', $aChanges))
					{
						$appId = $this->Get('applicationsolution_id');
						$lnkFriendlyName = "$myContactId $appId";
						$lnk = MetaModel::GetObjectFromOQL("SELECT lnkContactToApplicationSolution WHERE friendlyname='$lnkFriendlyName'");
						if(!$lnk && !UserRights::IsAdministrator())
						{
							$this->m_aCheckIssues[] = Dict::Format("Class:Url/Error:CanOnlyUpdateUrlOfYours", $myContactId);
						}
					}
					
					$this->Set("name", $this->Get("url"));
					
					// 自动填充curl字段
					$method = $this->Get("method");
					$headers_arr = json_decode($this->Get("headers"), true);
					$headers = "";
					if($headers_arr)
					{
						foreach($headers_arr as $k=>$v)
						{
							$k = str_replace(" ", "", $k);
							if($k != "")
							{
								$headers = $headers . "-H \"$k: $v\" ";
							}
						}
					}
					
					// GET参数
					$params = $this->Get("params");
					if($method == "GET")
					{
						$url = $this->Get("url");
						if ($params != "")
						{
							$url = $url . "?" . $params;
						}
						$curl = "curl -s -X$method " . $headers . "\"$url\"";
					}else
					{
						$url = $this->Get("url");
						if ($params != "")
						{
							$url = $url . "?" . $params;
						}
						$body = str_replace(array("\r\n", "\r", "\n"), "", $this->Get("body"));
						$curl = "curl -s -X$method " . $headers . "\"$url\"" . " --data '" . $body . "'";
					}
					$this->Set("curl", $curl);
					
				}]]></code>
				</method>
			</methods>
			<relations>
				<relation id="impacts">
					<neighbours>
						<neighbour id="applicationsolution_id" _delta="define">
							<attribute>applicationsolution_id</attribute>
						</neighbour>					
					</neighbours>
				</relation>
			</relations>
		</class>		

		<class id="Rack" _delta="define">
			<parent>PhysicalDevice</parent>
			<properties>
				<category>bizmodel,searchable</category>
				<abstract>false</abstract>
				<key_type>autoincrement</key_type>
				<db_table>rack</db_table>
				<db_key_field>id</db_key_field>
				<db_final_class_field/>
				<naming>
					<attributes>
						<attribute id="location_name"/>
						<attribute id="name"/>
					</attributes>
				</naming>
				<display_template/>
				<icon>images/rack.png</icon>
				<reconciliation>
					<attributes>
						<attribute id="name"/>
						<attribute id="friendlyname"/>
						<attribute id="org_id"/>
						<attribute id="organization_name"/>
					</attributes>
				</reconciliation>
			</properties>
			<fields>
				<field id="server_list" xsi:type="AttributeLinkedSet">
					<linked_class>Server</linked_class>
					<filter>SELECT Server AS S WHERE S.location_id=:this->location_id</filter>
					<ext_key_to_me>rack_id</ext_key_to_me>
					<count_max>0</count_max>
					<count_min>0</count_min>
					<duplicates/>
				</field>
			</fields>
			<methods/>
			<presentation>
				<details>
					<items>
						<item id="server_list">
							<rank>10</rank>
						</item>
						<item id="name">
							<rank>10</rank>
						</item>
						<item id="org_id">
							<rank>20</rank>
						</item>
						<item id="location_id">
							<rank>25</rank>
						</item>
						<item id="status">
							<rank>30</rank>
						</item>

						<item id="description">
							<rank>130</rank>
						</item>
					</items>
				</details>
				<search>
					<items>
						<item id="name">
							<rank>10</rank>
						</item>
						<item id="org_id">
							<rank>20</rank>
						</item>
						<item id="location_id">
							<rank>25</rank>
						</item>
						<item id="status">
							<rank>30</rank>
						</item>
					</items>
				</search>
				<list>
					<items>
						<item id="ci_id">
							<rank>100</rank>
						</item>					
						<item id="org_id">
							<rank>90</rank>
						</item>
						<item id="location_id">
							<rank>25</rank>
						</item>
						<item id="status">
							<rank>30</rank>
						</item>
					</items>
				</list>
			</presentation>
			<relations>
				<relation id="impacts">
					<neighbours>
						<neighbour id="server">
							<attribute>server_list</attribute>
						</neighbour>
					</neighbours>
				</relation>
			</relations>
		</class>

		<class id="Typology">
			<methods>
				<method id="DoCheckToWrite" _delta="define">
					<static>false</static>
					<access>protected</access>
					<type>Overload-DBObject</type>
					<code><![CDATA[	   public function DoCheckToWrite()
				{
					parent::DoCheckToWrite();

					// friendlyname has to be unique! Currently it' not possible to define this in datamodel (xml)
					
					$finalclass = $this->Get('finalclass');

					$nameSpec = MetaModel::GetNameSpec(get_class($this));
					$sFormat = preg_replace('/%[1-9]\$s/', '%s', $nameSpec['0']);
					$sArg = $nameSpec['1'];
					$oArg = array();
					
					/*
					 * 如果组成friendlyname的所有attribute都没有发生变化，那么不进行检查
					 * 如果不监听变化就进行检查，将导致对象无法更新
					 */
					$aChanges = $this->ListChanges();
					
					$isChanges = false;
					foreach($aChanges as $key=>$value)
					{   
						if(MetaModel::IsValidKeyAttCode($finalclass, $key))
						{   
							$extKeyFriends = MetaModel::GetExtKeyFriends($finalclass, $key);
							foreach($extKeyFriends as $k=>$v)
							{   
								if(in_array($k, $sArg))
								{   
									$isChanges = true;
								}
							}
						 
						}
						if(in_array($key, $sArg))
						{   
							$isChanges = true;
						}
					}
					
					foreach($sArg as $value) {
						array_push($oArg, $this->Get($value));
					}
					$sTypology = vsprintf("$sFormat", $oArg);
					//print_r($this->Get('name') . "<br>");
					//print_r($this->Get('brand_name') . "<br>");
					//print_r($this->Get('friendlyname') . "<br>");
					//print_r($oArg);
					//print_r("<br>");
					
					if($isChanges) {
						$oSearch = DBObjectSearch::FromOQL_AllData("SELECT $finalclass WHERE friendlyname=:friendlyname");
						$oSet = new DBObjectSet($oSearch, array(), array('friendlyname' => $sTypology));
						if ($oSet->Count() > 0)
						{
							$this->m_aCheckIssues[] = Dict::Format("Class:".$finalclass."/Error:".$finalclass."MustBeUnique", $sTypology);
						}
					}

				}]]></code>
				</method>
			</methods>
		</class>

		<class id="Model">
			<properties>
				<naming>
					<attributes _delta="redefine">
						<attribute id="brand_name"/>
						<attribute id="name"/>
					</attributes>

				</naming>
			</properties>
			<fields>
				<field id="type" xsi:type="AttributeEnum">
					<values _delta="redefine">
						<value id="Server">Server</value>
					</values>
				</field>
			</fields>
		</class>
		<class id="OSVersion">
			<properties>
				<naming>
					<attributes _delta="redefine">
						<attribute id="osfamily_name"/>
						<attribute id="name"/>
					</attributes>
				</naming>
			</properties>
		</class>
		<class id="ISP" _delta="define">
			<parent>Typology</parent>
			<properties>
				<category>bizmodel,searchable</category>
				<abstract>false</abstract>
				<key_type>autoincrement</key_type>
				<db_table>isp</db_table>
				<db_key_field>id</db_key_field>
				<db_final_class_field/>
				<naming>
					<attributes>
						<attribute id="name"/>
					</attributes>
				</naming>
				<display_template/>
				<icon/>
				<reconciliation>
					<attributes>
						<attribute id="name"/>
						<attribute id="code"/>
					</attributes>
				</reconciliation>
			</properties>
			<fields>
				<field id="code" xsi:type="AttributeString">
					<sql>code</sql>
					<default_value/>
					<is_null_allowed>false</is_null_allowed>
				</field>
				<field id="location_list" xsi:type="AttributeLinkedSet">
					<linked_class>Location</linked_class>
					<ext_key_to_me>isp_id</ext_key_to_me>
					<edit_mode>add_only</edit_mode>
					<count_min>0</count_min>
					<count_max>0</count_max>
					<duplicates/>
				</field>
				<field id="vip_list" xsi:type="AttributeLinkedSet">
					<linked_class>VirtualIP</linked_class>
					<ext_key_to_me>isp_id</ext_key_to_me>
					<edit_mode>add_only</edit_mode>
					<count_min>0</count_min>
					<count_max>0</count_max>
					<duplicates/>
				</field>

			</fields>
			<methods/>
			<presentation>
				<details>
					<items>
						<item id="name">
							<rank>10</rank>
						</item>
						<item id="code">
							<rank>20</rank>
						</item>
						<item id="location_list">
							<rank>40</rank>
						</item>
						<item id="vip_list">
							<rank>40</rank>
						</item>

					</items>
				</details>
				<search>
					<items>
						<item id="name">
							<rank>10</rank>
						</item>
						<item id="code">
							<rank>20</rank>
						</item>
					</items>
				</search>
				<list>
					<items>
						<item id="name">
							<rank>10</rank>
						</item>
						<item id="code">
							<rank>20</rank>
						</item>
					</items>
				</list>
			</presentation>
		</class>
		<class id="lnkServerToCluster" _delta="define">
			<parent>cmdbAbstractObject</parent>
			<properties>
				<is_link>1</is_link>
				<category>bizmodel</category>
				<abstract>false</abstract>
				<key_type>autoincrement</key_type>
				<db_table>lnkservertocluster</db_table>
				<db_key_field>id</db_key_field>
				<db_final_class_field/>
				<naming>
					<attributes>
						<attribute id="server_id"/>
						<attribute id="cluster_id"/>
					</attributes>
				</naming>
				<display_template/>
				<icon/>
				<reconciliation>
					<attributes>
						<attribute id="server_id"/>
						<attribute id="cluster_id"/>
					</attributes>
				</reconciliation>
			</properties>
			<fields>
				<field id="server_id" xsi:type="AttributeExternalKey">
					<sql>server_id</sql>
					<target_class>Server</target_class>
					<is_null_allowed>false</is_null_allowed>
					<on_target_delete>DEL_AUTO</on_target_delete>
				</field>
				<field id="server_hostname" xsi:type="AttributeExternalField">
					<extkey_attcode>server_id</extkey_attcode>
					<target_attcode>hostname</target_attcode>
				</field>
				<field id="server_cpu" xsi:type="AttributeExternalField">
					<extkey_attcode>server_id</extkey_attcode>
					<target_attcode>cpu</target_attcode>
				</field>
				<field id="server_ram" xsi:type="AttributeExternalField">
					<extkey_attcode>server_id</extkey_attcode>
					<target_attcode>ram</target_attcode>
				</field>
				<field id="server_location" xsi:type="AttributeExternalField">
					<extkey_attcode>server_id</extkey_attcode>
					<target_attcode>location_id</target_attcode>
				</field>
				<field id="server_brand" xsi:type="AttributeExternalField">
					<extkey_attcode>server_id</extkey_attcode>
					<target_attcode>brand_id</target_attcode>
				</field>
				<field id="server_model" xsi:type="AttributeExternalField">
					<extkey_attcode>server_id</extkey_attcode>
					<target_attcode>model_id</target_attcode>
				</field>

				<field id="cluster_id" xsi:type="AttributeExternalKey">
					<sql>cluster_id</sql>
					<target_class>Cluster</target_class>
					<is_null_allowed>false</is_null_allowed>
					<on_target_delete>DEL_AUTO</on_target_delete>
				</field>
				<field id="cluster_name" xsi:type="AttributeExternalField">
					<extkey_attcode>cluster_id</extkey_attcode>
					<target_attcode>name</target_attcode>
				</field>
			</fields>
			<methods/>
			<presentation>
				<details>
					<items>
						<item id="server_id">
							<rank>10</rank>
						</item>
						<item id="cluster_id">
							<rank>20</rank>
						</item>
					</items>
				</details>
				<search>
					<items>
						<item id="server_id">
							<rank>10</rank>
						</item>
						<item id="cluster_id">
							<rank>20</rank>
						</item>
					</items>
				</search>
				<list>
					<items>
						<item id="server_id">
							<rank>10</rank>
						</item>
						<item id="cluster_id">
							<rank>20</rank>
						</item>
						<item id="server_hostname">
							<rank>30</rank>
						</item>
						<item id="server_cpu">
							<rank>40</rank>
						</item>
						<item id="server_ram">
							<rank>50</rank>
						</item>
						<item id="server_location">
							<rank>60</rank>
						</item>
						<item id="server_model">
							<rank>80</rank>
						</item>
					</items>
				</list>
			</presentation>

		</class>
		<class id="lnkServerToVirtualIP" _delta="define">
			<parent>cmdbAbstractObject</parent>
			<properties>
				<is_link>1</is_link>
				<category>bizmodel</category>
				<abstract>false</abstract>
				<key_type>autoincrement</key_type>
				<db_table>lnkservertovirtualip</db_table>
				<db_key_field>id</db_key_field>
				<db_final_class_field/>
				<naming>
					<attributes>
						<attribute id="server_id"/>
						<attribute id="vip_id"/>
					</attributes>
				</naming>
				<display_template/>
				<icon/>
				<reconciliation>
					<attributes>
						<attribute id="server_id"/>
						<attribute id="vip_id"/>
					</attributes>
				</reconciliation>
			</properties>
			<fields>
				<field id="server_id" xsi:type="AttributeExternalKey">
					<sql>server_id</sql>
					<target_class>Server</target_class>
					<is_null_allowed>false</is_null_allowed>
					<on_target_delete>DEL_AUTO</on_target_delete>
				</field>
				<field id="server_hostname" xsi:type="AttributeExternalField">
					<extkey_attcode>server_id</extkey_attcode>
					<target_attcode>hostname</target_attcode>
				</field>
				<field id="server_cpu" xsi:type="AttributeExternalField">
					<extkey_attcode>server_id</extkey_attcode>
					<target_attcode>cpu</target_attcode>
				</field>
				<field id="server_ram" xsi:type="AttributeExternalField">
					<extkey_attcode>server_id</extkey_attcode>
					<target_attcode>ram</target_attcode>
				</field>
				<field id="server_location" xsi:type="AttributeExternalField">
					<extkey_attcode>server_id</extkey_attcode>
					<target_attcode>location_id</target_attcode>
				</field>
				<field id="server_model" xsi:type="AttributeExternalField">
					<extkey_attcode>server_id</extkey_attcode>
					<target_attcode>model_id</target_attcode>
				</field>

				<field id="vip_id" xsi:type="AttributeExternalKey">
					<sql>vip_id</sql>
					<target_class>VirtualIP</target_class>
					<is_null_allowed>false</is_null_allowed>
					<on_target_delete>DEL_AUTO</on_target_delete>
				</field>
				<field id="vip_name" xsi:type="AttributeExternalField">
					<extkey_attcode>vip_id</extkey_attcode>
					<target_attcode>ipaddress</target_attcode>
				</field>
			</fields>
			<methods/>
			<presentation>
				<details>
					<items>
						<item id="server_id">
							<rank>10</rank>
						</item>
						<item id="vip_id">
							<rank>20</rank>
						</item>
					</items>
				</details>
				<search>
					<items>
						<item id="server_id">
							<rank>10</rank>
						</item>
						<item id="server_hostname">
							<rank>30</rank>
						</item>
						<item id="server_location">
							<rank>60</rank>
						</item>

						<item id="vip_id">
							<rank>20</rank>
						</item>
					</items>
				</search>
				<list>
					<items>
						<item id="server_id">
							<rank>10</rank>
						</item>
						<item id="vip_id">
							<rank>20</rank>
						</item>
						<item id="server_cpu">
							<rank>40</rank>
						</item>
						<item id="server_ram">
							<rank>50</rank>
						</item>
						<item id="server_location">
							<rank>60</rank>
						</item>
						<item id="server_model">
							<rank>80</rank>
						</item>
					</items>
				</list>
			</presentation>

		</class>

		<class id="lnkContactToApplicationSolution" _delta="define">
			<parent>cmdbAbstractObject</parent>
			<properties>
				<is_link>1</is_link>
				<category>bizmodel</category>
				<abstract>false</abstract>
				<key_type>autoincrement</key_type>
				<db_table>lnkcontacttoapplicationsolution</db_table>
				<db_key_field>id</db_key_field>
				<db_final_class_field/>
				<naming>
					<attributes>
						<attribute id="contact_id"/>
						<attribute id="applicationsolution_id"/>
					</attributes>
				</naming>
				<display_template/>
				<icon _delta="define">../le-config-mgmt/images/contact.png</icon>
				<reconciliation>
					<attributes>
						<attribute id="contact_id"/>
						<attribute id="applicationsolution_id"/>
					</attributes>
				</reconciliation>
			</properties>
			<fields>
				<field id="contact_id" xsi:type="AttributeExternalKey">
					<sql>contact_id</sql>
					<target_class>Contact</target_class>
					<is_null_allowed>false</is_null_allowed>
					<on_target_delete>DEL_AUTO</on_target_delete>
				</field>
				<field id="contact_name" xsi:type="AttributeExternalField">
					<extkey_attcode>contact_id</extkey_attcode>
					<target_attcode>friendlyname</target_attcode>
				</field>
				<field id="contact_email" xsi:type="AttributeExternalField">
					<extkey_attcode>contact_id</extkey_attcode>
					<target_attcode>email</target_attcode>
				</field>
				<field id="applicationsolution_id" xsi:type="AttributeExternalKey">
					<sql>applicationsolution_id</sql>
					<target_class>ApplicationSolution</target_class>
					<is_null_allowed>false</is_null_allowed>
					<on_target_delete>DEL_AUTO</on_target_delete>
				</field>
				<field id="applicationsolution_name" xsi:type="AttributeExternalField">
					<extkey_attcode>applicationsolution_id</extkey_attcode>
					<target_attcode>name</target_attcode>
				</field>
				<field id="applicationsolution_name_cn" xsi:type="AttributeExternalField">
					<extkey_attcode>applicationsolution_id</extkey_attcode>
					<target_attcode>name_cn</target_attcode>
				</field>
				<field id="applicationsolution_org" xsi:type="AttributeExternalField">
					<extkey_attcode>applicationsolution_id</extkey_attcode>
					<target_attcode>org_id</target_attcode>
				</field>
			</fields>
			<methods>
				<method id="updateContacts" _delta="define">
					<static>false</static>
					<access>public</access>
					<type>Custom</type>
					<code><![CDATA[
						public function updateContacts($IsDelete=false)
						{
							// 自动更新applicationsolution的contacts字段
							$sAppId = $this->Get('applicationsolution_id');
							if($sAppId > 0) 
							{    
								$sOql = "SELECT lnkContactToApplicationSolution AS l WHERE l.applicationsolution_id=:applicationsolution_id";
								$nSearch = DBObjectSearch::FromOQL_AllData($sOql);
								$oSet = new DBObjectSet($nSearch, array(), array('applicationsolution_id' => $sAppId));
								$oArray = $oSet->ToArrayOfValues();
								$contacts = array();
								foreach($oArray as $v)
								{    
									$name = preg_replace("/@.*/","",$v['l.contact_email']);
									$phone = $v['l.contact_phone'];
									$item = "$name($phone)";
									array_push($contacts,$item);
								}
								$aCurrent = preg_replace("/@.*/", "", $this->Get("contact_email")) . "(" . $this->Get("contact_phone") . ")";
								if($IsDelete)
								{
									$newcontacts = array();
									foreach($contacts as $v)
									{
										if($v == $aCurrent)
										{
											continue;
										}
										array_push($newcontacts, $v);
									}
									//die(json_encode($newcontacts));
									$contacts = $newcontacts;
								}else
								{
									array_push($contacts, $aCurrent);
								}
								
								array_unique($contacts);
								$contacts_str = implode(",", $contacts);
								//die($contacts_str);
								
								// 使用API修改对象（当前登录用户可能没有某些类的修改权限）
								$iTopAPI = new iTopClient();
								$iTopAPI->coreUpdate("ApplicationSolution", $sAppId, array("contacts"=>$contacts_str));
							}   						
						}
					]]>
					</code>
				</method>			
				<method id="ReloadAndDisplayCustom" _delta="define">
					<static>false</static>
					<access>public</access>
					<type>Custom</type>
					<code><![CDATA[
					function ReloadAndDisplayCustom($oPage, $oObj, $sMessageId = '', $sMessage = '', $sSeverity = null)
					{
						$oAppContext = new ApplicationContext();
						if ($sMessageId != '')
						{
							cmdbAbstractObject::SetSessionMessage(get_class($oObj), $oObj->GetKey(), $sMessageId, $sMessage, $sSeverity, 0, true /* must not exist */);
						}
						
						$oId = $oObj->getKey();
						$oPage->add_header('Location: '.utils::GetAbsoluteUrlAppRoot().'pages/UI.php?operation=details&class='.get_class($oObj).'&id='.$oId.'&'.$oAppContext->GetForLink());
					}
					]]>
					</code>
				</method>			
				<method id="DisplayModifyForm" _delta="define">
					<static>false</static>
					<access>public</access>
					<type>Overload-cmdbAbstractObject</type>
					<code><![CDATA[
						public function DisplayModifyForm(WebPage $oPage, $aExtraParams = array())
						{
							if(!UserRights::IsAdministrator())
							{
								$sMesg = Dict::Format("Class:lnkContactToApplicationSolution/Error:NotAllowDirectCreation", get_class($this));
								if($this->IsNew())
								{
									$sMesg = $sMesg . '...<a href="'.utils::GetAbsoluteUrlAppRoot().'pages/UI.php?operation=modify&class=Person&id='.UserRights::GetContactId().'">'.Dict::Format("Class:lnkContactToApplicationSolution/Msg:EditMySelf").'</a>';
									$oPage->add("<div class=\"header_message message_info\">$sMesg</div>\n");
								}else
								{
									self::ReloadAndDisplayCustom($oPage, $this, 'lnkcontacttoapplicationsolution-no-direct', $sMesg, 'info');
								}
							}else
							{
								parent::DisplayModifyForm($oPage, $aExtraParams);
							}
						}
					]]>
					</code>
				</method>			
				<method id="DoCheckToWrite" _delta="define">
					<static>false</static>
					<access>protected</access>
					<type>Overload-DBObject</type>
					<code><![CDATA[  public function DoCheckToWrite(){
			/* 允许研发编辑app时添加删除联系人, 取消这里的检查
			$myContactId = UserRights::GetContactId();
			$thisContactId = $this->Get('contact_id');
			$thisContactName = $this->Get('contact_name');
			if ($myContactId != $thisContactId && !UserRights::IsAdministrator()){
				$this->m_aCheckIssues[] = Dict::Format("Class:lnkContactToApplicationSolution/Error:CanOnlyAddLinkForYourself", $thisContactName);
			}
			*/
			
			$aChanges = $this->ListChanges();
			if($aChanges)
			{
				$friendlyname = $this->Get('contact_id') . " " . $this->Get('applicationsolution_id');
				if(!$this->IsNew())
				{
					$this->m_aCheckIssues[] = Dict::Format("Class:lnkContactToApplicationSolution/Error:OnlyAddAndDeleteIsAllow", $friendlyname);				
				}else
				{
					$oSearch = DBObjectSearch::FromOQL_AllData("SELECT lnkContactToApplicationSolution WHERE friendlyname=:friendlyname");
					$oSet = new DBObjectSet($oSearch, array(), array("friendlyname" => $friendlyname));
					
					if ($oSet->Count() > 0)
					{
						$this->m_aCheckIssues[] = Dict::Format("Class:lnkContactToApplicationSolution/Error:ThisLnkAlreadyExists", $friendlyname);
					}else
					{
						self::updateContacts();
					}
				}
			}
		}]]>
					</code>
				</method>
				<method id="CheckToDelete" _delta="define">
					<static>false</static>
					<access>protected</access>
					<type>Overload-DBObject</type>
					<code><![CDATA[	   
  	public function CheckToDelete(&$oDeletionPlan)
  	{
		$myContactId = UserRights::GetContactId();
		$thisContactId = $this->Get('contact_id');
  		if ($myContactId != $thisContactId && !UserRights::IsAdministrator())
		{
			// 普通用户不允许删除非自己名下的lnkContactToApplicationSolution
			$oDeletionPlan->AddToDelete($this, null);
			$oDeletionPlan->SetDeletionIssues($this, array('只能删除自己名下的关联'), true);
			$oDeletionPlan->ComputeResults();
			return false;
		}
		return parent::CheckToDelete($oDeletionPlan);
  	} 
			]]></code>
				</method>
				<method id="AfterDelete" _delta="define">
					<static>false</static>
					<access>protected</access>
					<type>Overload-DBObject</type>
					<code><![CDATA[	   
					protected function AfterDelete()
					{
						parent::AfterDelete();
						self::updateContacts(true);
					} 
			]]></code>
				</method>
			</methods>
			<presentation>
				<details>
					<items>
						<item id="applicationsolution_id">
							<rank>10</rank>
						</item>
						<item id="contact_id">
							<rank>20</rank>
						</item>						
					</items>
				</details>
				<search>
					<items>
						<item id="applicationsolution_id">
							<rank>10</rank>
						</item>
						<item id="contact_id">
							<rank>20</rank>
						</item>
						<item id="contact_email">
							<rank>30</rank>
						</item>
						<item id="applicationsolution_name_cn">
							<rank>40</rank>
						</item>
						<item id="applicationsolution_org">
							<rank>50</rank>
						</item>

					</items>
				</search>
				<list>
					<items>
						<item id="applicationsolution_id">
							<rank>10</rank>
						</item>
						<item id="contact_id">
							<rank>20</rank>
						</item>
						<item id="contact_email">
							<rank>30</rank>
						</item>
						<item id="applicationsolution_name_cn">
							<rank>40</rank>
						</item>
						<item id="applicationsolution_org">
							<rank>50</rank>
						</item>

					</items>
				</list>
			</presentation>

		</class>

		<class id="lnkContactToFunctionalCI">
			<fields>
				<field id="contact_email" xsi:type="AttributeExternalField" _delta="define">
					<extkey_attcode>contact_id</extkey_attcode>
					<target_attcode>email</target_attcode>
				</field>
				<field id="contact_phone" xsi:type="AttributeExternalField" _delta="define">
					<extkey_attcode>contact_id</extkey_attcode>
					<target_attcode>phone</target_attcode>
				</field>

			</fields>
			<presentation>
				<list>
					<items _delta="redefine">
						<item id="functionalci_id">
							<rank>10</rank>
						</item>
						<item id="contact_id">
							<rank>20</rank>
						</item>
						<item id="contact_email">
							<rank>30</rank>
						</item>
						<item id="contact_phone">
							<rank>40</rank>
						</item>
					</items>
				</list>
			</presentation>

		</class>
		<class id="lnkApplicationSolutionToFunctionalCI">
			<properties>
				<icon _delta="redefine">../le-config-mgmt/images/link.png</icon>
			</properties>
			<methods>
				<method id="ReloadAndDisplayCustom" _delta="define">
					<static>false</static>
					<access>public</access>
					<type>Custom</type>
					<code><![CDATA[
					function ReloadAndDisplayCustom($oPage, $oObj, $sMessageId = '', $sMessage = '', $sSeverity = null)
					{
						$oAppContext = new ApplicationContext();
						if ($sMessageId != '')
						{
							cmdbAbstractObject::SetSessionMessage(get_class($oObj), $oObj->GetKey(), $sMessageId, $sMessage, $sSeverity, 0, true /* must not exist */);
						}
						
						$oId = $oObj->getKey();
						$oPage->add_header('Location: '.utils::GetAbsoluteUrlAppRoot().'pages/UI.php?operation=details&class='.get_class($oObj).'&id='.$oId.'&'.$oAppContext->GetForLink());
					}
					]]>
					</code>
				</method>			
				<method id="DisplayModifyForm" _delta="define">
					<static>false</static>
					<access>public</access>
					<type>Overload-cmdbAbstractObject</type>
					<code><![CDATA[
						public function DisplayModifyForm(WebPage $oPage, $aExtraParams = array())
						{
							if(!UserRights::IsAdministrator())
							{
								$sMesg = Dict::Format("Class:lnkApplicationSolutionToFunctionalCI/Error:NotAllowDirectCreation", get_class($this));
								if($this->IsNew())
								{
									$sMesg = $sMesg . '...<a href="'.utils::GetAbsoluteUrlAppRoot().'pages/UI.php?c%5Bmenu%5D=ApplicationSolution">'.Dict::Format("Class:lnkApplicationSolutionToFunctionalCI/Msg:EditApp").'</a>';
									$oPage->add("<div class=\"header_message message_info\">$sMesg</div>\n");
								}else
								{
									self::ReloadAndDisplayCustom($oPage, $this, 'lnkApplicationSolutionToFunctionalCI-no-direct', $sMesg, 'info');
								}
							}else
							{
								parent::DisplayModifyForm($oPage, $aExtraParams);
							}
						}
					]]>
					</code>
				</method>			
				<method id="DoCheckToWrite" _delta="define">
					<static>false</static>
					<access>protected</access>
					<type>Overload-DBObject</type>
					<code><![CDATA[  public function DoCheckToWrite(){
			$aChanges = $this->ListChanges();
			if($aChanges)
			{
				$friendlyname = $this->Get('friendlyname');
				if(!$this->IsNew())
				{
					$this->m_aCheckIssues[] = Dict::Format("Class:lnkApplicationSolutionToFunctionalCI/Error:OnlyAddAndDeleteIsAllow", $friendlyname);				
				}else
				{
					$oSearch = DBObjectSearch::FromOQL_AllData("SELECT lnkApplicationSolutionToFunctionalCI WHERE friendlyname=:friendlyname");
					$oSet = new DBObjectSet($oSearch, array(), array("friendlyname" => $friendlyname));
					
					if ($oSet->Count() > 0)
					{
						$this->m_aCheckIssues[] = Dict::Format("Class:lnkApplicationSolutionToFunctionalCI/Error:ThisLnkAlreadyExists", $friendlyname);
					}				
				}
			}
		}]]>
					</code>
				</method>
				<method id="CheckToDelete" _delta="define">
					<static>false</static>
					<access>protected</access>
					<type>Overload-DBObject</type>
					<code><![CDATA[	   
  	public function CheckToDelete(&$oDeletionPlan)
  	{
		$myContactId = UserRights::GetContactId();
		$appId = $this->Get('applicationsolution_id');

		$sObj = NULL;
		
		if($myContactId>0)
		{
			$oql = "SELECT lnkContactToApplicationSolution AS l WHERE l.contact_id = $myContactId AND l.applicationsolution_id = $appId";
			$sObj = MetaModel::GetObjectFromOQL($oql);		
		}
		
  		if (!$sObj && !UserRights::IsAdministrator())
		{
			// 普通用户不允许删除非自己名下的lnkApplicationSolutionToFunctionalCI
			$oDeletionPlan->AddToDelete($this, null);
			$oDeletionPlan->SetDeletionIssues($this, array('只能删除自己名下APP的关联'), true);
			$oDeletionPlan->ComputeResults();
			return false;
		}
		return parent::CheckToDelete($oDeletionPlan);
  	} 
			]]></code>
				</method>
			</methods>
		</class>
		<class id="lnkDatabaseToServer" _delta="define">
			<parent>cmdbAbstractObject</parent>
			<properties>
				<is_link>1</is_link>
				<category>bizmodel</category>
				<abstract>false</abstract>
				<key_type>autoincrement</key_type>
				<db_table>lnkdatabasetoserver</db_table>
				<db_key_field>id</db_key_field>
				<db_final_class_field/>
				<naming>
					<attributes>
						<attribute id="database_id"/>
						<attribute id="server_id"/>
					</attributes>
				</naming>
				<display_template/>
				<icon _delta="define">../le-config-mgmt/images/contact.png</icon>
				<reconciliation>
					<attributes>
						<attribute id="database_id"/>
						<attribute id="server_id"/>
					</attributes>
				</reconciliation>
			</properties>
			<fields>
				<field id="database_id" xsi:type="AttributeExternalKey">
					<sql>database_id</sql>
					<target_class>Database</target_class>
					<is_null_allowed>false</is_null_allowed>
					<on_target_delete>DEL_AUTO</on_target_delete>					
				</field>
				<field id="database_name" xsi:type="AttributeExternalField">
					<extkey_attcode>database_id</extkey_attcode>
					<target_attcode>friendlyname</target_attcode>				
				</field>
				<field id="server_id" xsi:type="AttributeExternalKey">
					<sql>server_id</sql>
					<target_class>Server</target_class>
					<is_null_allowed>false</is_null_allowed>
					<on_target_delete>DEL_AUTO</on_target_delete>				
				</field>
				<field id="server_name" xsi:type="AttributeExternalField">
					<extkey_attcode>server_id</extkey_attcode>
					<target_attcode>friendlyname</target_attcode>				
				</field>
			</fields>
			<methods/>
			<presentation>
				<details>
					<items>
						<item id="database_id">
							<rank>10</rank>
						</item>
						<item id="server_id">
							<rank>20</rank>
						</item>						
					</items>
				</details>
				<search>
					<items>
						<item id="database_id">
							<rank>10</rank>
						</item>
						<item id="server_id">
							<rank>20</rank>
						</item>
					</items>
				</search>
				<list>
					<items>
						<item id="database_id">
							<rank>10</rank>
						</item>
						<item id="server_id">
							<rank>20</rank>
						</item>
					</items>
				</list>
			</presentation>
		</class>
	</classes>
	<menus>
		<menu id="ConfigManagementOverview" xsi:type="DashboardMenuNode">
			<definition>
				<cells>
					<cell id="0">
						<dashlets>
							<dashlet id="ip" xsi:type="DashletBadge" _delta="define">
								<rank>20</rank>
								<class>PhysicalIP</class>
							</dashlet>
							<dashlet id="vip" xsi:type="DashletBadge" _delta="define">
								<rank>21</rank>
								<class>VirtualIP</class>
							</dashlet>
							<dashlet id="cluster" xsi:type="DashletBadge" _delta="define">
								<rank>4</rank>
								<class>Cluster</class>
							</dashlet>
							<dashlet id="domain" xsi:type="DashletBadge" _delta="define">
								<rank>4</rank>
								<class>Domain</class>
							</dashlet>
							<dashlet id="3" _delta="delete"></dashlet>
						</dashlets>
					</cell>
					<cell id="3">
						<dashlets>
							<dashlet id="13" xsi:type="DashletBadge" _delta="delete"></dashlet>
							<dashlet id="5" xsi:type="DashletBadge" _delta="delete"></dashlet>
							<dashlet id="6" xsi:type="DashletBadge" _delta="delete"></dashlet>
							<dashlet id="7" xsi:type="DashletBadge" _delta="delete"></dashlet>
							<dashlet id="8" xsi:type="DashletBadge" _delta="delete"></dashlet>
							<dashlet id="9" xsi:type="DashletBadge" _delta="delete"></dashlet>
							<dashlet id="10" xsi:type="DashletBadge" _delta="delete"></dashlet>
							<dashlet id="11" xsi:type="DashletBadge" _delta="delete"></dashlet>
							<dashlet id="12" xsi:type="DashletBadge" _delta="delete"></dashlet>
							<dashlet id="14" xsi:type="DashletBadge" _delta="delete"></dashlet>
							<dashlet id="rds" xsi:type="DashletBadge" _delta="define">
								<rank>20</rank>
								<class>RDS</class>
							</dashlet>
							<dashlet id="mongodb" xsi:type="DashletBadge" _delta="define">
								<rank>20</rank>
								<class>MongoDB</class>
							</dashlet>
							<dashlet id="mysql" xsi:type="DashletBadge" _delta="define">
								<rank>30</rank>
								<class>MySQL</class>
							</dashlet>
							<dashlet id="redis" xsi:type="DashletBadge" _delta="define">
								<rank>30</rank>
								<class>Redis</class>
							</dashlet>
							<dashlet id="app" xsi:type="DashletBadge" _delta="define">
								<rank>10</rank>
								<class>ApplicationSolution</class>
							</dashlet>
							<dashlet id="url" xsi:type="DashletBadge" _delta="define">
								<rank>15</rank>
								<class>Url</class>
							</dashlet>

						</dashlets>
					</cell>
					<cell id="4">
						<dashlets>
							<dashlet id="vlan" xsi:type="DashletBadge" _delta="delete"></dashlet>
							<dashlet id="16" xsi:type="DashletBadge" _delta="delete"></dashlet>
							<dashlet id="17" xsi:type="DashletBadge" _delta="delete"></dashlet>
							<dashlet id="19" xsi:type="DashletBadge" _delta="delete"></dashlet>
							<dashlet id="lnk" xsi:type="DashletBadge" _delta="define">
								<rank>90</rank>
								<class>lnkApplicationSolutionToFunctionalCI</class>
							</dashlet>
							<dashlet id="lnkcontacttoapp" xsi:type="DashletBadge" _delta="define">
								<rank>100</rank>
								<class>lnkContactToApplicationSolution</class>
							</dashlet>							
							<dashlet id="idc" xsi:type="DashletBadge" _delta="define">
								<rank>80</rank>
								<class>Location</class>
							</dashlet>
							<dashlet id="rack" xsi:type="DashletBadge" _delta="define">
								<rank>81</rank>
								<class>Rack</class>
							</dashlet>

							<dashlet id="person" xsi:type="DashletBadge" _delta="define">
								<rank>70</rank>
								<class>Person</class>
							</dashlet>
							<dashlet id="team" xsi:type="DashletBadge" _delta="define">
								<rank>60</rank>
								<class>Team</class>
							</dashlet>							
						</dashlets>
					</cell>
				</cells>
			</definition>
		</menu>

		<menu id="Typology" xsi:type="DashboardMenuNode">
			<definition>
				<cells>
					<cell id="0">
						<dashlets>
							<dashlet id="6" _delta="delete"></dashlet>
							<dashlet id="isp" xsi:type="DashletBadge" _delta="define">
								<rank>8</rank>
								<class>ISP</class>
							</dashlet>
						</dashlets>
					</cell>
				</cells>
			</definition>
		</menu>

		<menu id="WelcomeMenuPage" xsi:type="DashboardMenuNode" _delta="redefine">
			<rank>10</rank>
			<parent>WelcomeMenu</parent>
			<definition>
				<layout>DashboardLayoutTwoCols</layout>
				<title></title>
				<auto_reload>
					<enabled>false</enabled>
					<interval>300</interval>
				</auto_reload>
				<cells>
					<cell id="0" _delta="redefine">
						<rank>0</rank>
						<dashlets>
							<dashlet id="1" xsi:type="DashletHeaderStatic">
								<rank>0</rank>
								<title>Menu:ConfigManagementCI</title>
								<icon>itop-welcome-itil/images/database.png</icon>
							</dashlet>
							<dashlet id="2" xsi:type="DashletBadge">
								<rank>1</rank>
								<class>BusinessProcess</class>
							</dashlet>
							<dashlet id="3" xsi:type="DashletBadge">
								<rank>2</rank>
								<class>ApplicationSolution</class>
							</dashlet>
							<dashlet id="4" xsi:type="DashletBadge">
								<rank>3</rank>
								<class>Contact</class>
							</dashlet>
							<dashlet id="database" xsi:type="DashletBadge">
								<rank>4</rank>
								<class>Database</class>
							</dashlet>
							<dashlet id="domain" xsi:type="DashletBadge">
								<rank>5</rank>
								<class>Domain</class>
							</dashlet>
							<dashlet id="7" xsi:type="DashletBadge">
								<rank>6</rank>
								<class>Server</class>
							</dashlet>
							<dashlet id="url" xsi:type="DashletBadge"  _delta="define">
								<rank>5</rank>
								<class>Url</class>
							</dashlet>							

						</dashlets>
					</cell>
					<cell id="statistics" _delta="redefine">
						<rank>1</rank>
						<dashlets>
							<dashlet id="8" xsi:type="DashletHeaderStatic">
								<rank>0</rank>
								<title>&#x7EDF;&#x8BA1;&#x4FE1;&#x606F;</title>
								<icon>itop-config-mgmt/images/webserver.png</icon>
							</dashlet>
							<dashlet id="9" xsi:type="DashletGroupByPie">
								<rank>1</rank>
								<title>Server Brand</title>
								<query>SELECT Server</query>
								<group_by>brand_id</group_by>
								<style>pie</style>
							</dashlet>
						</dashlets>
					</cell>
					<cell id="2" _delta="redefine">
						<rank>2</rank>
						<dashlets>
							<dashlet id="10" xsi:type="DashletGroupByPie">
								<rank>2</rank>
								<title>Server Location</title>
								<query>SELECT Server</query>
								<group_by>location_id</group_by>
								<style>pie</style>
							</dashlet>	
						</dashlets>							
					</cell>
					<cell id="3" _delta="redefine">
						<rank>3</rank>
						<dashlets>
							<dashlet id="12" xsi:type="DashletGroupByPie">
								<rank>0</rank>
								<title>Business - Org</title>
								<query>SELECT BusinessProcess</query>
								<group_by>org_id</group_by>
								<style>pie</style>
							</dashlet>
						</dashlets>						
					</cell>
					<cell id="4" _delta="redefine">
						<rank>4</rank>
						<dashlets>
							<dashlet id="13" xsi:type="DashletGroupByPie">
								<rank>0</rank>
								<title>App - Business</title>
								<query>SELECT ApplicationSolution</query>
								<group_by>businessprocess_id</group_by>
								<style>pie</style>
							</dashlet>
						</dashlets>
					</cell>
					<cell id="5" _delta="redefine">
						<rank>5</rank>
						<dashlets>
							<dashlet id="11" xsi:type="DashletGroupByPie">
								<rank>7</rank>
								<title>Person - Org</title>
								<query>SELECT Person</query>
								<group_by>org_id</group_by>
								<style>pie</style>
							</dashlet>							
						</dashlets>
					</cell>
				</cells>
			</definition>
		</menu>
		<menu id="Software" xsi:type="OQLMenuNode" _delta="delete"></menu>
		<menu id="Server" xsi:type="OQLMenuNode" _delta="define">
			<rank>7</rank>
			<parent>SearchCIs</parent>
			<oql>SELECT Server</oql>
			<do_search>1</do_search>
		</menu>
		<menu id="Domain" xsi:type="OQLMenuNode" _delta="define">
			<rank>10</rank>
			<parent>SearchCIs</parent>
			<oql>SELECT Domain</oql>
			<do_search>1</do_search>
		</menu>
		<menu id="ApplicationSolution" xsi:type="OQLMenuNode" _delta="define">
			<rank>20</rank>
			<parent>SearchCIs</parent>
			<oql>SELECT ApplicationSolution</oql>
			<do_search>1</do_search>
		</menu>
		<menu id="lnkContactToApplicationSolution" xsi:type="OQLMenuNode" _delta="define">
			<rank>20</rank>
			<parent>SearchCIs</parent>
			<oql>SELECT lnkContactToApplicationSolution</oql>
			<do_search>1</do_search>
		</menu>

		<menu id="Url" xsi:type="OQLMenuNode" _delta="define">
			<rank>21</rank>
			<parent>SearchCIs</parent>
			<oql>SELECT Url</oql>
			<do_search>1</do_search>
		</menu>

		<menu id="Cluster" xsi:type="OQLMenuNode" _delta="define">
			<rank>30</rank>
			<parent>SearchCIs</parent>
			<oql>SELECT Cluster</oql>
			<do_search>1</do_search>
		</menu>
		<menu id="IPAddress" xsi:type="OQLMenuNode" _delta="define">
			<rank>40</rank>
			<parent>SearchCIs</parent>
			<oql>SELECT PhysicalIP</oql>
			<do_search>1</do_search>
		</menu>
		<menu id="VirtualIP" xsi:type="OQLMenuNode" _delta="define">
			<rank>50</rank>
			<parent>SearchCIs</parent>
			<oql>SELECT VirtualIP</oql>
			<do_search>1</do_search>
		</menu>
		<menu id="Database" xsi:type="DashboardMenuNode" _delta="define">
			<rank>52</rank>
			<parent>SearchCIs</parent>
			<definition>
				<layout>DashboardLayoutOneCol</layout>
				<title/>
				<cells>
					<cell id="0">
						<rank>0</rank>
						<dashlets>
							<dashlet id="1" xsi:type="DashletHeaderDynamic">
								<rank>1</rank>
								<title>Menu:Database</title>
								<icon>le-config-mgmt/images/database.png</icon>
								<subtitle>Menu:Database:Count</subtitle>
								<query>SELECT Database</query>
								<group_by>status</group_by>
								<values>active,inactive</values>
							</dashlet>
							<dashlet id="2" xsi:type="DashletBadge">
								<rank>2</rank>
								<class>RDS</class>
							</dashlet>
							<dashlet id="3" xsi:type="DashletBadge">
								<rank>3</rank>
								<class>MySQL</class>
							</dashlet>
							<dashlet id="3" xsi:type="DashletBadge">
								<rank>4</rank>
								<class>MongoDB</class>
							</dashlet>
							<dashlet id="3" xsi:type="DashletBadge">
								<rank>5</rank>
								<class>Redis</class>
							</dashlet>
						</dashlets>
					</cell>
				</cells>
			</definition>

		</menu>
		<menu id="NewContact" _delta="delete"></menu>
		<menu id="SearchContacts" _delta="delete"></menu>
		<menu id="Team" xsi:type="OQLMenuNode" _delta="define">
			<rank>3</rank>
			<parent>Contact</parent>
			<oql>SELECT Team</oql>
			<do_search>1</do_search>
		</menu>
		<menu id="Person" xsi:type="OQLMenuNode" _delta="define">
			<rank>4</rank>
			<parent>Contact</parent>
			<oql>SELECT Person</oql>
			<do_search>1</do_search>
		</menu>
	</menus>
	<user_rights>
		<groups>
			<group id="Develope" _delta="define">
				<classes>
					<class id="Person"/>
				</classes>
			</group>
			<group id="PM" _delta="define">
				<classes>
					<class id="Contact"/>
				</classes>
			</group>
			<group id="EditTeam" _delta="define">
				<classes>
					<class id="lnkPersonToTeam"/>
				</classes>
			</group>
			<group id="EditCIs" _delta="define">
				<classes>
					<class id="lnkContactToApplicationSolution"/>
					<class id="lnkApplicationSolutionToFunctionalCI"/>
				</classes>
			</group>
			<group id="Urls" _delta="define">
				<classes>
					<class id="Url"/>					
				</classes>
			</group>
			<group id="App" _delta="define">
				<classes>
					<class id="ApplicationSolution"/>					
				</classes>
			</group>
		</groups>
		<profiles>
			<profile id="4" _delta="delete"></profile>
			<profile id="5" _delta="delete"></profile>
			<profile id="6" _delta="delete"></profile>
			<profile id="7" _delta="delete"></profile>
			<profile id="8" _delta="delete"></profile>
			<profile id="10" _delta="delete"></profile>
			<profile id="11" _delta="delete"></profile>
			<profile id="3">
				<name _delta="redefine">配置经理</name>
				<description _delta="redefine">配置经理是修改维护CMDB配置项的人</description>
			</profile>
			<profile id="9">
				<name _delta="redefine">变更审批</name>
				<description _delta="redefine">变更审批者是能影响变更审批的人</description>
			</profile>
			<profile id="2">
				<description _delta="redefine">Portal user(门户用户)能访问iTop门户。不具有其它任何标准应用访问权限的人，将被自动重定向到用户门户</description>
			</profile>
			<profile id="12">
				<description _delta="redefine">高级门户用户是能够查看某个用户下所有票单的人。它还必须具有其它角色，如门户用户的角色</description>
			</profile>

			<profile id="101" _delta="define">
				<name>只读用户</name>
				<description>只读方式浏览CMDB并发起工单</description>
				<groups>
					<group id="UserRequest">
						<actions>
							<action id="action:write">allow</action>
							<action id="stimulus:ev_close">allow</action>
							<action id="stimulus:ev_reopen">allow</action>
						</actions>
					</group>
					<group id="*">
						<actions>
							<action id="action:read">allow</action>
							<action id="action:bulk read">allow</action>
						</actions>
					</group>
				</groups>
			</profile>
			<profile id="102" _delta="define">
				<name>研发</name>
				<description>允许修改Person类，并通过DoCheckToWrite控制只能修改自己link的Person</description>
				<groups>
					<group id="Develope">
						<actions>
							<action id="action:write">allow</action>
						</actions>
					</group>
					<group id="EditTeam">
						<actions>
							<action id="action:delete">allow</action>
						</actions>
					</group>
					<group id="EditCIs">
						<actions>
							<action id="action:write">allow</action>
							<action id="action:delete">allow</action>
						</actions>
					</group>
					<group id="Urls">
						<actions>
							<action id="action:write">allow</action>
							<action id="action:bulk write">allow</action>
							<action id="action:delete">allow</action>
							<action id="stimulus:ev_new">allow</action>
							<action id="stimulus:ev_online">allow</action>
							<action id="stimulus:ev_offline">allow</action>
						</actions>
					</group>
					<group id="App">
						<actions>
							<action id="action:write">allow</action>
						</actions>
					</group>
					<group id="UserRequest">
						<actions>
							<action id="action:write">allow</action>
							<action id="stimulus:ev_close">allow</action>
							<action id="stimulus:ev_reopen">allow</action>
						</actions>
					</group>					
					<group id="*">
						<actions>
							<action id="action:read">allow</action>
							<action id="action:bulk read">allow</action>
						</actions>
					</group>
				</groups>
			</profile>
			<profile id="103" _delta="define">
				<name>产品经理</name>
				<description>允许修改Contact类</description>
				<groups>
					<group id="PM">
						<actions>
							<action id="action:write">allow</action>
						</actions>
					</group>
					<group id="EditTeam">
						<actions>
							<action id="action:delete">allow</action>
						</actions>
					</group>
					<group id="EditCIs">
						<actions>
							<action id="action:write">allow</action>
							<action id="action:delete">allow</action>
						</actions>
					</group>
					<group id="App">
						<actions>
							<action id="action:write">allow</action>
						</actions>
					</group>					
					<group id="UserRequest">
						<actions>
							<action id="action:write">allow</action>
							<action id="stimulus:ev_close">allow</action>
							<action id="stimulus:ev_reopen">allow</action>
						</actions>
					</group>
					<group id="*">
						<actions>
							<action id="action:read">allow</action>
							<action id="action:bulk read">allow</action>
						</actions>
					</group>
				</groups>
			</profile>
			<profile id="104" _delta="define">
				<name>工单机器人</name>
				<description>只允许修改UserRequest</description>
				<groups>
					<group id="UserRequest">
						<actions>
							<action id="action:write">allow</action>
						</actions>
					</group>
					<group id="*">
						<actions>
							<action id="action:read">allow</action>
							<action id="action:bulk read">allow</action>
						</actions>
					</group>
				</groups>
			</profile>
		</profiles>
	</user_rights>
	<branding>
		<main_logo>images/logo.png</main_logo>
		<login_logo>images/logo.png</login_logo>
		<portal_logo>images/logo.png</portal_logo>
	</branding>
</itop_design>
